---
title: "Maize_Spread_Processes"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Maize_Spread_Processes}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
editor_options: 
  chunk_output_type: console
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup, include = FALSE, results = 'hide', echo = FALSE, warning = FALSE, message = FALSE, error = FALSE, results = 'hide'}

# devtools::install()
# devtools::load_all()
library(cropSpreadR)
require(ggh4x)
library(cropDiffusionR)

```


```{r load_data, include = FALSE, results = 'hide', echo = FALSE, warning = FALSE, message = FALSE, error = FALSE, results = 'hide'} 

# Load the temperature anomaly reconstruction from paleoMAT.
temp_anom <-
  readr::read_csv(
    "https://raw.githubusercontent.com/Archaeo-Programmer/paleoMAT/master/vignettes/tables/supp_table_s2.csv",
    show_col_types = FALSE
  ) %>%
  dplyr::rename(
    year = 1,
    anom = 2,
    ci = 3,
    se = 4
  )

# Load location data for each sample. Site location are not saved in this repository, as we want to ensure that archaeological site locations are protected. %>% str_remove("project_root/")
MDB <- cropDiffusionR::maizeDB %>%
  dplyr::left_join(.,
                   readr::read_csv(
                     stringr::str_remove(
                       here::here("Paper 2/Maize_Database_Locations_DONT_DISTRIBUTE.csv"),
                       "cropSpreadR/"
                     ),
                     col_types = readr::cols()
                   ),
                   by = "LabID")

# Get modern annual accumulated growing degree days at each sample location. We use WorldClim 30 sec. (~1 km) for Mexico and use PRISM (~800 meters) for USA.
MDB_gdd_wc <- MDB %>%
  sf::st_as_sf(coords = c("Long", "Lat"), crs = 4326) %>%
  dplyr::select(LabID) %>%
  cropDiffusionR::extract_GDD(gdd_raster = cropDiffusionR::WorldClim_annual_gdd,
                              sites = .)

MDB_gdd_prism <- MDB %>%
  sf::st_as_sf(coords = c("Long", "Lat"), crs = 4326) %>%
  dplyr::select(LabID) %>%
  cropDiffusionR::extract_GDD(gdd_raster = cropSpreadR::PRISM_annual_gdd,  sites = .)

MDB_gdd <-
  dplyr::left_join(MDB_gdd_prism, MDB_gdd_wc, by = "LabID") %>%
  dplyr::mutate(GDD = dplyr::coalesce(GDD.x, GDD.y)) %>%
  dplyr::select(-c(GDD.x, GDD.y))


# Add GDD and elevation to maize dataset.
MDB_env <- MDB %>%
  dplyr::select(-Elevation_masl) %>%
  dplyr::left_join(., MDB_gdd, by = "LabID") %>%
  # Add elevation to dataset.
  dplyr::left_join(., cropSpreadR::MDB_elev, by = "LabID")


MDB3 <- MDB %>%
  dplyr::filter(Province %in% c("Arizona", "New Mexico", "Colorado", "Utah"))


mlr <- MDB_env %>%
  dplyr::group_by(SiteIDName) %>%
  dplyr::slice_min(Date) %>%
  dplyr::filter(Lat >= 30 & Date < 1500) %>%
  dplyr::mutate(bin = cut(
    Date,
    breaks = seq(-3700, 1500, 100))) %>% 
  dplyr::group_by(bin) %>% 
  dplyr::mutate(group = dplyr::cur_group_id())

fit <- lm(Date ~ Lat + GDD + elevation, data = mlr)
summary(fit)

ggplot(mlr, aes(Date, Lat)) +
  geom_smooth(method = 'lm', formula = y ~ x) +
  #scale_x_reverse() +
  geom_point()

#load car package
library(car)

#produce added variable plots
avPlots(fit)


```


```{r}

df <- MDB_env %>%
  dplyr::filter(Lat > 30)

grid.dist0 <- GSIF::buffer.dist(df["MedianBP"], rast[1], as.factor(1:nrow(df)))


```

```{r environmental_stats}

MDB_env2 <- MDB_env %>%
  dplyr::filter(Date < 1500) %>%
  dplyr::group_by(gr = cut(Date,
                           breaks = seq(-4500, 1500,500),
                           labels = seq(-4250, 1250,500))) %>% 
  dplyr::mutate(date2 = as.numeric(as.character(gr))) %>% 
  dplyr::ungroup() %>% 
  dplyr::select(-gr) %>% 
  dplyr::arrange(date2) %>% 
  dplyr::rename(Latitude = Lat, Elevation = elevation)

env_summaries <- MDB_env2 %>% 
  dplyr::summarise(across(c(Latitude, GDD, Elevation), ~ mean(.x, na.rm = TRUE)))


env_summaries_bp <-
  MDB_env2 %>%
  dplyr::select(date2, Latitude, GDD, Elevation) %>%
  tidyr::pivot_longer(-date2) %>%
  ggplot(aes(
    x = factor(date2),
    y = value,
    fill = factor(name)
  )) +
  geom_boxplot() +
  facet_grid(vars(name), scales = "free") +
  labs(fill = "") +
  xlab("Years BC/AD") +
  ylab("Value") +
  theme_bw() +
  theme(
    strip.text.y = element_text(size = 12),
    legend.key.size = unit(1.5, "cm"),
    legend.text = element_text(size = 12),
    axis.ticks.length = unit(0.125, "inch"),
    #ggh4x.axis.ticks.length.minor = rel(0.5),
    axis.text = element_text(
      size = 26,
      colour = "black",
      family = "Helvetica"
    ),
    axis.title.y = element_text(
      size = 28,
      family = "Helvetica",
      margin = margin(
        t = 10,
        r = 5,
        b = 10,
        l = 10
      )
    ),
    axis.title.x = element_text(
      size = 28,
      family = "Helvetica",
      margin = margin(
        t = 5,
        r = 10,
        b = 10,
        l = 10
      )
    ),
    axis.line = element_line(colour = "black"),
    plot.margin = margin(
      t = 5,
      r = 25,
      b = 5,
      l = 5
    )
  )

ggplot2::ggsave(
  filename = here::here("vignettes/figures/env_boxplots.png"),
  plot = env_summaries_bp,
  width = 15.51,
  height = 10.32,
  dpi = 600
)


```

```{r spd}

counties10sf <-
  sf::st_as_sf(maps::map("county", fill = TRUE, plot = FALSE)) %>%
  sf::st_transform(., crs = 4326) %>%
  tidyr::separate(ID, into = c("REGION", "NAME"), sep = ",") %>%
  dplyr::filter(REGION %in% c("colorado", "utah", "arizona", "new mexico")) %>%
  sf::st_make_valid()

bad_loc <- p3k14c::p3k14c_data %>%
  dplyr::filter(Province %in% c("Arizona", "New Mexico", "Colorado", "Utah")) %>%
  dplyr::filter(LocAccuracy == 0 & !is.na(SiteName)) %>%
  dplyr::select(-c(Long, Lat)) %>%
  dplyr::left_join(., MDB %>% dplyr::select(SiteName, Long, Lat) %>% dplyr::distinct(SiteName, .keep_all = TRUE ), by = "SiteName") %>%
  dplyr::filter(!is.na(Long))

sf::sf_use_s2(FALSE)

Four_corners <- p3k14c::p3k14c_data %>%
  dplyr::filter(Province %in% c("Arizona", "New Mexico", "Colorado", "Utah")) %>%
  dplyr::filter(stringr::str_detect(Taxa, "Zea|zea")) %>%
  dplyr::filter(LocAccuracy > 0) %>%
  dplyr::bind_rows(., bad_loc) %>%
  dplyr::distinct() %>%
  dplyr::mutate (calib = "intcal20", db = "p3k14c",
                 d13C = as.numeric(d13C)) %>%
  dplyr::bind_rows(., MDB %>% dplyr::select(intersect(names(p3k14c::p3k14c_data),names(MDB)), SiteIDName) %>% dplyr::mutate(db = "mine", calib = "intcal20")) %>%
  dplyr::group_by(LabID) %>%
  dplyr::arrange(LabID, db) %>%
  dplyr::slice(1) %>%
  sf::st_as_sf(  # Convert to spatial object
    coords = c("Long", "Lat"),
    crs = 4326
  ) %>%
  sf::st_make_valid() %>%
  sf::st_join(counties10sf)

MDB3A <- MDB %>%
  dplyr::filter(Country == "USA") %>%
  dplyr::select(LabID, Long, Lat, SiteIDName, MedianBP) %>%
  dplyr::mutate(SiteIDName = ifelse(SiteIDName == "Willard Mounds", "42BO3", SiteIDName))

by_county <- readr::read_rds("/Users/andrew/Dropbox/WSU/SKOPEII/model/Paper 3/four-corners-counties.rds")

by_county2 <- by_county %>%
  # dplyr::select(-data)
  dplyr::mutate(spds = purrr::map(spds,
                    ~ dplyr::mutate(.x,
                             presence = ifelse(PrDens == 0, 0, 1),
                             change = tsibble::difference(presence, default = dplyr::first(presence)),
                             firstdiff = tsibble::difference(PrDens, default = dplyr::first(PrDens)),
                             change_words = ifelse(change == 1, "Begin occupation",
                                                   ifelse(change == -1, "End occupation", 0))
                    )
  )) %>%
  dplyr::mutate(REGION = dplyr::case_when(REGION == "UT" ~ "utah",
                                          REGION == "CO" ~ "colorado",
                                          REGION == "NM" ~ "new mexico",
                                          REGION == "AZ" ~ "arizona"),
                NAME = tolower(NAME)) %>%
  dplyr::mutate(county_st = paste(NAME, REGION, sep = ", "))

fig6_county_st <- MDB_min_fig6 %>% 
    sf::st_as_sf(  # Convert to spatial object
    coords = c("Long", "Lat"),
    crs = 4326
  ) %>%
  sf::st_make_valid() %>%
  sf::st_join(counties10sf) %>% 
  dplyr::mutate(county_st = paste(NAME, REGION, sep = ", "))

maize_temp2 <- Four_corners %>%
  dplyr::filter(LabID != "Beta-122953") %>%
  dplyr::mutate(county_st = paste(NAME, REGION, sep = ", ")) %>%
  dplyr::filter(county_st %in% fig6_county_st$county_st) %>%
  dplyr::select(county_st, Age, Error, calib)

maize_temp2b <-
  rcarbon::calibrate(x = maize_temp2$Age,
                     errors = maize_temp2$Error,
                     calCurves = maize_temp2$calib,
                     verbose = FALSE) %>%
  summary() %>%
  dplyr::bind_cols(maize_temp2, .) %>%
  dplyr::select(county_st, MedianBP) %>%
  sf::st_drop_geometry() %>%
  dplyr::group_by(county_st) %>%
  dplyr::slice_max(MedianBP, with_ties = FALSE) %>% 
  dplyr::mutate(county_st = tools::toTitleCase(county_st))

county_lat <- p3k14c::p3k14c_data %>%
  dplyr::filter(Province %in% c("Arizona", "New Mexico", "Colorado", "Utah")) %>%
  dplyr::filter(LocAccuracy > 0) %>%
  dplyr::mutate(Long1 = Long, Lat1 = Lat) %>% 
  sf::st_as_sf(  # Convert to spatial object
    coords = c("Long1", "Lat1"),
    crs = 4326
  ) %>%
  sf::st_make_valid() %>%
  sf::st_join(counties10sf) %>% 
  dplyr::mutate(county_st = paste(NAME, REGION, sep = ", ")) %>% 
  dplyr::group_by(county_st) %>% 
  dplyr::slice(1) %>% 
  dplyr::select(county_st, Lat) %>% 
  sf::st_drop_geometry() %>% 
  dplyr::arrange(desc(Lat)) %>% 
  dplyr::mutate(county_st = tools::toTitleCase(county_st)) %>% 
  dplyr::filter(county_st %in% maize_temp2b$county_st)
  

by_county_changes <- by_county2 %>%
  dplyr::filter(county_st %in% fig6_county_st$county_st) %>%
  dplyr::mutate(county_st = tools::toTitleCase(county_st)) %>% 
  tidyr::unnest(cols = c(spds)) %>%
  dplyr::left_join(maize_temp2b, ., by = "county_st") %>%
  dplyr::mutate(MedianBP = ifelse(MedianBP == calBP, MedianBP, NA)) %>% 
  dplyr::left_join(., county_lat, by = "county_st") %>% 
  dplyr::mutate(county_st = tools::toTitleCase(county_st))

spd_plot <- ggplot(data = by_county_changes, aes(y = PrDens, x = calBP)) +
  geom_line() +
  geom_point(aes(y = PrDens, x = MedianBP), size = 2.25, color = "red", inherit.aes = FALSE) +
  theme_bw() +
  scale_x_reverse(breaks = seq(0, 7000, 1000), limits = c(7000, 0)) +
  facet_wrap(~factor(county_st, levels=unique(county_lat$county_st)), scales = "free_y", ncol = 1) +
  xlab("Years cal BP") +
  ylab("Summed Probability") +
  theme(
    strip.text.x = element_text(size = 14),
    axis.ticks.length = unit(0.125, "inch"),
    #ggh4x.axis.ticks.length.minor = rel(0.5),
    panel.border = element_blank(),
    panel.grid.major = element_blank(),
    axis.text = element_text(
      size = 20,
      colour = "black",
      family = "Helvetica"
    ),
    axis.title.y = element_text(
      size = 28,
      family = "Helvetica",
      margin = margin(
        t = 10,
        r = 5,
        b = 10,
        l = 10
      )
    ),
    axis.title.x = element_text(
      size = 28,
      family = "Helvetica",
      margin = margin(
        t = 5,
        r = 10,
        b = 10,
        l = 10
      )
    ),
    panel.grid.minor = element_blank(),
    axis.line = element_line(colour = "black"),
    plot.margin = margin(
      t = 5,
      r = 25,
      b = 5,
      l = 5
    )
  )

ggplot2::ggsave(
  filename = here::here("vignettes/figures/spd_plotb.png"),
  plot = spd_plot,
  width = 15.51,
  height = 17.32,
  dpi = 600
)


```

```{r TPS}

TPS_inter <- MDB %>%
  dplyr::group_by(SiteIDName) %>%
  dplyr::slice_max(MedianBP) %>%
  dplyr::filter(Lat >= 30 & Date < 1500)

df <- data.frame(x = TPS_inter$Long, y = TPS_inter$Lat, z = TPS_inter$MedianBP)

library(sp)
library(rgdal)
library(geosphere)
library(raster)
library(fields)

x = TPS_inter$Long
y = TPS_inter$Lat
z = TPS_inter$MedianBP

# convert data to a SpatialPointsDataFrame object
xysp <- SpatialPointsDataFrame(
      matrix(c(x,y), ncol=2), data.frame(ID=seq(1:length(x))),
      proj4string=CRS("+proj=longlat +ellps=WGS84 +datum=WGS84"))

# use the distm function to generate a geodesic distance matrix in meters
mdist <- distm(xysp)

# cluster all points using a hierarchical clustering approach
hc <- hclust(as.dist(mdist), method="complete")

# define the distance threshold, in this case 40 m
d=6437.38

# define clusters based on a tree "height" cutoff "d" and add them to the SpDataFrame
xyp2 <- xysp
xyp2$clust <- cutree(hc, h=d)

df_clus <- as.data.frame(xyp2, z, TPS_inter$SiteIDName) %>%
  dplyr::group_by(clust) %>%
  dplyr::slice_max(z, with_ties = FALSE) %>%
  dplyr::ungroup() %>%
  dplyr::select(-c(ID, clust)) %>% 
  dplyr::filter(!TPS_inter.SiteIDName %in% c("AA:12:745", "AA:12:232"))
  #dplyr::mutate(z = ifelse(TPS_inter.SiteIDName %in% c("AA:12:745", 	"AA:12:232", "BB:13:6", "AA:12:91", "AA:12:111"), 5089.5, z))



xy <- data.frame(x = df_clus$coords.x1, y = df_clus$coords.x2)
z2 = df_clus$z
rast <- raster::raster(ext = extent(xy),
                       crs = 4326,
                       resolution = 0.01)

m <- fields::Tps(xy, z2)
surface <- raster::interpolate(rast, m)

png(
  here::here("vignettes/figures/date_map_contour.png"),
  units = "in",
  width = 15.43,
  height = 13.15,
  res = 600
)

plot(
  cropSpreadR::PRISM_annual_gdd,
  xlim = c(-113.7015,-104.7915),
  ylim = c(30.30626, 41.47626),
  col = wes_palette("Zissou1", 21, type = "continuous"),
  asp = NA,
  xaxt = 'n',
  yaxt = 'n',
  legend.args = list(
    text = "         cal BP \n",
    side = 3,
    font = 2,
    cex = 1.5
  ),
  legend.width = 1.25,
  legend.shrink = 0.75
)
contour(
  cropSpreadR::PRISM_annual_gdd,
  asp = NA,
  add = TRUE,
  labcex = 1.1,
  xaxt = 'n',
  yaxt = 'n',
  vfont = c("sans serif", "bold")
)
maps::map(
  'state',
  add = TRUE,
  lwd = 1.5,
  lty = 1,
  col = "grey28"
)

dev.off()


# will need to rename colnames for raster
colnames(df) <- c('x', 'y', 'vals')

# create a raster object
r_obj <- raster(xmn=-113.75, xmx=-104.8, ymn=30.25, ymx=41.5, resolution=c(0.05,0.05))

# use rasterize to create desired raster
r_data <- rasterize(x=df[, 1:2], # lon-lat data
                    y=r_obj, # raster object
                    field=df[, 3], # vals to fill raster with
                    fun=max) # aggregate function

plot(r_data)


library(raster)
library(fields)

ok3 <- ok2

xy <- data.frame(x = ok3$x, y = ok3$y)
z = ok3$z
rast <- raster(ext=extent(xy), crs=4326, resolution = 0.01)

m <- fields::Tps(xy, z)
surface <- raster::interpolate(rast, m)

plot(surface)
contour(surface, add = TRUE)

# Get raster for the North American Southwest and convert to a dataframe.
NASW_gdd_data <-
  raster::as.data.frame(surface, xy = TRUE)
# Assign names to the columns.
names(NASW_gdd_data) <- c("long", "lat", "GDD")
#Transform the data for plotting in ggplot.
NASW_gdd_data_transformed <-
  usmap::usmap_transform(
    NASW_gdd_data,
    input_names = c("long", "lat"),
    output_names = c("x", "y")
  )

ggplot2::ggplot(data = NASW_gdd_data_transformed) +
  geom_raster(aes(x = long, y = lat, fill = GDD),
              alpha = 0.8,
              na.rm = TRUE) +
  #For GDD raster in color.
  scale_fill_gradientn(colors = colorRampPalette(rev(RColorBrewer::brewer.pal(11, "RdBu")))(255),
                       na.value = "transparent",
                       name = "Annual GDDs") +
  coord_equal() +
  theme_bw() +
    aes(x = long,
      y = lat,
      z = GDD,
      fill = GDD) +
  stat_contour(geom="polygon", binwidth=500) + 
  geom_contour(color = "white", alpha = 0.8) +
  geom_text_contour(binwidth = 500) +
  
  
  geom_sf(
    data = cropDiffusionR::usa_mexico_states,
    color = "#2b2b2b",
    fill = "transparent",
    size = 0.4,
    inherit.aes = FALSE
  ) +
  theme(
    legend.position = c(.15, .2),
    panel.border = element_blank(),
    panel.grid.major = element_blank(),
    axis.text = element_blank(),
    axis.text.x = element_blank(),
    axis.title = element_blank(),
    axis.line = element_blank(),
    axis.ticks = element_blank(),
    legend.text = element_text(size = 15, family = "Helvetica"),
    legend.title = element_text(
      size = 16,
      family = "Helvetica",
      face = "bold"
    )
  )



```


```{r code_exploration} 


library(tidyverse)

MDB2 <- MDB %>% 
  filter(Lat >= 30) %>% 
  arrange(Lat, Long)

interpolated <- interp(MDB2$Long, MDB2$Lat, MDB2$MedianBP, 
                       duplicate = "mean",    #you have duplicated values
                       output = "grid")

#convert this to a long form dataframe
interp_df <- expand_grid(i = seq_along(interpolated$x), 
                         j = seq_along(interpolated$y)) %>% 
  dplyr::mutate(lon = interpolated$x[i],
         lat = interpolated$y[j],
         emissions = map2_dbl(i, j, ~interpolated$z[.x,.y])) %>% 
  dplyr::select(-i, -j)

#then you can use this in your plot
ggplot()+
  geom_point(data = MDB2, aes(x = Long, y = Lat), col = "blue") +
  geom_contour(data = interp_df, aes(x = lon, y = lat, z = emissions), binwidth = 300) + 
  geom_text_contour(data = interp_df, aes(x = lon, y = lat, z = emissions), binwidth = 300) +
    geom_sf(
    data = cropDiffusionR::usa_mexico_states,
    color = "#2b2b2b",
    fill = "transparent",
    size = 0.4,
    inherit.aes = FALSE
  ) +
  scale_y_continuous(limits = c(30, 42)) +
  scale_x_continuous(limits = c(-115, -104))

library(akima)

fld <- with(MDB2, interp(x = Long, y = Lat, z = MedianBP, duplicate = "mean"))

ok <- filled.contour(x = fld$x,
               y = fld$y,
               z = fld$z,
               color.palette =
                 colorRampPalette(wes_palette("Zissou1", 21, type = "continuous")),
               xlab = "Longitude",
               ylab = "Latitude",
               main = "Years BP",
               #plot.axes=maps::map('state',add=T))
               plot.axes = { contour(fld$x,fld$y,fld$z,  
                                 drawlabels = TRUE, axes = FALSE, 
                                 frame.plot = FALSE, add = TRUE);
             axis(1); axis(2); maps::map('state',add=T); points(5, 5) })


library(raster)
library(fields)


xy <- data.frame(x = MDB2$Long, y = MDB2$Lat)
z = MDB2$MedianBP
rast <- raster(ext=extent(xy), crs=4326, resolution = 0.01)

m <- fields::Tps(xy, z)
surface <- raster::interpolate(rast, m)

plot(surface)
contour(surface, add = TRUE)


library(akima)
library(metR)
library("wesanderson")
library(scales)

MDB2 <- MDB %>% 
  dplyr::filter(Lat >= 30 & Date <= 1500) %>% 
  dplyr::arrange(desc(MedianBP)) %>% 
  dplyr::group_by(Long, Lat) %>% 
  dplyr::slice_max(MedianBP, with_ties = FALSE)

fld <- with(df_clus,
            interp(
              x = coords.x1,
              y = coords.x2,
              z = z,
              xo = seq(min(coords.x1), max(coords.x1), length = 800),
              yo = seq(min(coords.x2), max(coords.x2), length = 800)
              #duplicate = "mean"
            ))

gdat <- interp2xyz(fld, data.frame = TRUE)

ok <- ggplot(gdat) +
  aes(x = x,
      y = y,
      z = z,
      fill = z) +
  geom_tile() +
  coord_equal() +
  stat_contour(aes(fill= fit <<- ..level..), geom="polygon", binwidth=300) + 
  geom_contour(color = "white", alpha = 0.8) +
  geom_text_contour(binwidth = 300) +
  scale_fill_gradientn(colors = wes_palette("Zissou1", 21, type = "continuous"),
                       na.value = "transparent", name="Years BP") +
  theme_bw() +
  scale_y_continuous(limits = c(30, 42)) +
  scale_x_continuous(limits = c(-115, -104)) +
  geom_sf(
    data = cropDiffusionR::usa_mexico_states,
    color = "#2b2b2b",
    fill = "transparent",
    size = 0.4,
    inherit.aes = FALSE
  ) +
  #geom_point(data = MDB2, aes(x = Long, y = Lat), size = 3, inherit.aes = FALSE) +
  xlab("") +
  ylab("")


hello <- ggplot2::ggplot_build(ok)$data[[2]]

out <- hello %>% 
  dplyr::select(year = order, Long = x, Lat = y) %>% 
  sf::st_as_sf(coords = c("Long", "Lat"), crs = 4326, remove = FALSE) %>% 
  dplyr::bind_cols(., gdd = terra::extract(x = cropDiffusionR::NASW_gdd, y = .)) %>% 
  dplyr::filter(!is.na(gdd)) %>% 
  sf::st_drop_geometry() %>% 
  dplyr::group_by(year) %>% 
  summarise(Lat = mean(Lat), gdd = mean(gdd)) %>% 
  dplyr::arrange(desc(year)) %>% 
  dplyr::mutate(deltaLat = Lat - lag(Lat),
                deltaGDD = gdd - lag(gdd),
                date = rcarbon::BPtoBCAD(year))


# Change in latitude.
out %>%
  ggplot2::ggplot(aes(x = date, y = Lat)) +
  geom_line(size = 2, color = "#A60F2D") +
  xlab("Years BC/AD") +
  ylab("Latitude") +
  scale_x_continuous(breaks = seq(-2600, 1100, 300)) +
  # scale_y_continuous(
  #   breaks = seq(-0.7, 0, 0.1),
  #   limits = c(-0.7, 0),
  #   minor_breaks = seq(-0.65,-0.05, by = 0.05),
  #   guide = "axis_minor"
  # ) +
  theme_bw() +
  theme(
    axis.ticks.length = unit(0.125, "inch"),
    #ggh4x.axis.ticks.length.minor = rel(0.5),
    panel.border = element_blank(),
    panel.grid.major = element_blank(),
    axis.text = element_text(
      size = 26,
      colour = "black",
      family = "Helvetica"
    ),
    axis.title.y = element_text(
      size = 28,
      family = "Helvetica",
      margin = margin(
        t = 10,
        r = 5,
        b = 10,
        l = 10
      )
    ),
    axis.title.x = element_text(
      size = 28,
      family = "Helvetica",
      margin = margin(
        t = 5,
        r = 10,
        b = 10,
        l = 10
      )
    ),
    panel.grid.minor = element_blank(),
    axis.line = element_line(colour = "black"),
    plot.margin = margin(
      t = 5,
      r = 25,
      b = 5,
      l = 5
    )
  )

# Change in gdd (delta)
out %>%
  ggplot2::ggplot(aes(x = date, y = deltaGDD)) +
  geom_line(size = 2, color = "#A60F2D") +
  xlab("Years BC/AD") +
  ylab("Delta GDD") +
  scale_x_continuous(breaks = seq(-2600, 1100, 300)) +
  scale_y_reverse(
    breaks = seq(-4500, 500, 500)
  ) +
  theme_bw() +
  theme(
    axis.ticks.length = unit(0.125, "inch"),
    #ggh4x.axis.ticks.length.minor = rel(0.5),
    panel.border = element_blank(),
    panel.grid.major = element_blank(),
    axis.text = element_text(
      size = 26,
      colour = "black",
      family = "Helvetica"
    ),
    axis.title.y = element_text(
      size = 28,
      family = "Helvetica",
      margin = margin(
        t = 10,
        r = 5,
        b = 10,
        l = 10
      )
    ),
    axis.title.x = element_text(
      size = 28,
      family = "Helvetica",
      margin = margin(
        t = 5,
        r = 10,
        b = 10,
        l = 10
      )
    ),
    panel.grid.minor = element_blank(),
    axis.line = element_line(colour = "black"),
    plot.margin = margin(
      t = 5,
      r = 25,
      b = 5,
      l = 5
    )
  )


# GDD 
out %>%
  ggplot2::ggplot(aes(x = date, y = gdd)) +
  geom_line(size = 2, color = "#A60F2D") +
  xlab("Years BC/AD") +
  ylab("GDD") +
  scale_x_continuous(breaks = seq(-2600, 1100, 300)) +
  scale_y_reverse(
    breaks = seq(1000, 4000, 500)
  ) +
  theme_bw() +
  theme(
    axis.ticks.length = unit(0.125, "inch"),
    #ggh4x.axis.ticks.length.minor = rel(0.5),
    panel.border = element_blank(),
    panel.grid.major = element_blank(),
    axis.text = element_text(
      size = 26,
      colour = "black",
      family = "Helvetica"
    ),
    axis.title.y = element_text(
      size = 28,
      family = "Helvetica",
      margin = margin(
        t = 10,
        r = 5,
        b = 10,
        l = 10
      )
    ),
    axis.title.x = element_text(
      size = 28,
      family = "Helvetica",
      margin = margin(
        t = 5,
        r = 10,
        b = 10,
        l = 10
      )
    ),
    panel.grid.minor = element_blank(),
    axis.line = element_line(colour = "black"),
    plot.margin = margin(
      t = 5,
      r = 25,
      b = 5,
      l = 5
    )
  )

```


```{r spd_county_maps}

SW_counties <- tigris::counties(c("Arizona", "New Mexico", "Colorado", "Utah"))

ggplot() +
  geom_sf(data = SW_counties, color="black",
                   fill="white", size=0.25)



```
