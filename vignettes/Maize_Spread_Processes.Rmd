---
title: "Maize_Spread_Processes"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Maize_Spread_Processes}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
editor_options: 
  chunk_output_type: console
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup, include = FALSE, results = 'hide', echo = FALSE, warning = FALSE, message = FALSE, error = FALSE, results = 'hide'}

# devtools::install()
# devtools::load_all()
library(cropSpreadR)
require(ggh4x)
library(cropDiffusionR)

```

```{r load_data, include = FALSE, results = 'hide', echo = FALSE, warning = FALSE, message = FALSE, error = FALSE, results = 'hide'} 

# Load the temperature anomaly reconstruction from paleoMAT.
temp_anom <-
  readr::read_csv(
    "https://raw.githubusercontent.com/Archaeo-Programmer/paleoMAT/master/vignettes/tables/supp_table_s2.csv",
    show_col_types = FALSE
  ) %>%
  dplyr::rename(
    year = 1,
    anom = 2,
    ci = 3,
    se = 4
  )

# Load location data for each sample. Site locations are not saved in this repository, as we want to ensure that archaeological site locations are protected.
sf::sf_use_s2(FALSE)

MDB <- cropDiffusionR::maizeDB %>%
  dplyr::left_join(.,
                   readr::read_csv(
                     stringr::str_remove(
                       here::here("Paper 2/Maize_Database_Locations_DONT_DISTRIBUTE.csv"),
                       "cropSpreadR/"
                     ),
                     col_types = readr::cols()
                   ),
                   by = "LabID") %>%
  dplyr::mutate(Long1 = Long, Lat1 = Lat) %>%
  # Convert to spatial object
  sf::st_as_sf(coords = c("Long1", "Lat1"),
               crs = 4326) %>%
  sf::st_make_valid() %>%
  # Join to counties data to get county and state information.
  sf::st_join(cropSpreadR::SWUS_counties) %>%
  dplyr::mutate(county_st = ifelse(!is.na(REGION) &
                                     !is.na(NAME), paste(NAME, REGION, sep = ", "), NA)) %>%
  sf::st_drop_geometry() %>% 
  suppressMessages()

# Get modern annual accumulated growing degree days at each sample location. 
# For Mexico, we use WorldClim 30 sec. (~1 km) for GDD data.
MDB_gdd_wc <- MDB %>%
  sf::st_as_sf(coords = c("Long", "Lat"), crs = 4326) %>%
  dplyr::select(LabID) %>%
  cropDiffusionR::extract_GDD(gdd_raster = cropDiffusionR::WorldClim_annual_gdd,
                              sites = .)

# For USA, we use PRISM (~800 meters) for GDD data.
MDB_gdd_prism <- MDB %>%
  sf::st_as_sf(coords = c("Long", "Lat"), crs = 4326) %>%
  dplyr::select(LabID) %>%
  cropDiffusionR::extract_GDD(gdd_raster = cropSpreadR::PRISM_annual_gdd,  sites = .)

# Join the GDD together.
MDB_gdd <-
  dplyr::left_join(MDB_gdd_prism, MDB_gdd_wc, by = "LabID") %>%
  dplyr::mutate(GDD = dplyr::coalesce(GDD.x, GDD.y)) %>%
  dplyr::select(-c(GDD.x, GDD.y))

# Add GDD and elevation to maize dataset.
MDB_env <- MDB %>%
  dplyr::select(-Elevation_masl) %>%
  dplyr::left_join(., MDB_gdd, by = "LabID") %>%
  # Add elevation to dataset.
  dplyr::left_join(., cropSpreadR::MDB_elev, by = "LabID")

# Get sites that are on the northern maize frontier through time from cropDiffusionR package for the SWUS.
temp <- tempfile()
download.file(
  "https://raw.githubusercontent.com/Archaeo-Programmer/cropDiffusionR/master/vignettes/output/maize_frontier_swus.rds",
  temp
)
maize_frontier_swus <-
  readr::read_rds(temp, "maize_frontier_swus.rds")
unlink(temp)

maize_frontier_swus <- MDB %>%
  dplyr::filter(LabID %in% maize_frontier_swus$LabID) %>%
  dplyr::mutate(Long1 = Long, Lat1 = Lat) %>%
  # Convert to spatial object
  sf::st_as_sf(coords = c("Long1", "Lat1"),
               crs = 4326) %>%
  sf::st_make_valid()

# Get sites that are on the northern maize frontier through time from cropDiffusionR package for Mexico and SWUS.
temp <- tempfile()
download.file(
  "https://raw.githubusercontent.com/Archaeo-Programmer/cropDiffusionR/master/vignettes/output/maize_frontier_mexico.rds",
  temp
)
maize_frontier_mexico <-
  readr::read_rds(temp, "maize_frontier_mexico.rds")
unlink(temp)

maize_frontier_mexico <- MDB_env %>%
  dplyr::filter(LabID %in% maize_frontier_mexico$LabID) %>%
  dplyr::mutate(Long1 = Long, Lat1 = Lat) %>%
  # Convert to spatial object
  sf::st_as_sf(coords = c("Long1", "Lat1"),
               crs = 4326) %>%
  sf::st_make_valid() %>% 
  dplyr::mutate(centroid_long = ifelse(is.na(centroid_long), Long, centroid_long),
                centroid_lat = ifelse(is.na(centroid_lat), Lat, centroid_lat))

```

```{r  Figure_1, fig.cap="Figure 1. swus_date_distribution.", echo = FALSE, warning = FALSE, message = FALSE, error = FALSE, results = 'hide',fig.keep = 'all', fig.width = 15.51, fig.height = 10.32, fig.align = "left"}}

maize_earliest_distribution <-  MDB_env %>%
  dplyr::filter(Lat > 30 & Date < 1500) %>%
  dplyr::group_by(SiteIDName) %>%
  dplyr::slice_min(Date, with_ties = FALSE) %>%
  dplyr::mutate(sample = "Earliest Maize Subset")

full_distribution <- MDB_env %>%
  dplyr::filter(Lat > 30 & Date < 1500) %>%
  dplyr::mutate(sample = "Full Maize Database") %>%
  dplyr::filter(!LabID %in% maize_earliest_distribution$LabID)

swus_date_distribution_stacked <- maize_earliest_distribution %>%
  dplyr::bind_rows(., full_distribution) %>%
  dplyr::ungroup() %>%
  dplyr::mutate(sample = factor(sample, levels = c("Full Maize Database", "Earliest Maize Subset"))) %>%
  ggplot(aes(x = Date, fill = sample)) +
  geom_histogram(
    binwidth = 100,
    color = "#000000",
    position = "stack",
    center = -3650
  ) +
  scale_fill_manual(values = c("cornflowerblue", "#DDCC77")) +
  xlab("Year BC/AD") +
  ylab("Count") +
  scale_x_continuous(breaks = seq(-4000, 1500, 500),
                     limits = c(-4000, 1500)) +
  scale_y_continuous(breaks = seq(0, 90, 10), limits = c(0, 90)) +
  theme_classic() +
  annotate(
    geom = "text",
    x = -3550,
    y = 15,
    label = "Las Capas",
    hjust = 0,
    angle = 45,
    size = 6.75
  ) +
  annotate(
    "segment",
    x = -3650,
    xend = -3550,
    y = 1,
    yend = 13,
    colour = "black"
  ) +
  annotate(
    "segment",
    x = -3450,
    xend = -3550,
    y = 1,
    yend = 13,
    colour = "black"
  ) +
  # Annotation for Old Corn.
  annotate(
    geom = "text",
    x = -2150,
    y = 15,
    label = "Old Corn",
    hjust = 0,
    angle = 45,
    size = 6.75
  ) +
  annotate(
    "segment",
    x = -2250,
    xend = -2150,
    y = 1,
    yend = 13,
    colour = "black"
  ) +
  theme(
    legend.title = element_blank(),
    legend.text = element_text(size = 14,
                               family = "Helvetica"),
    panel.spacing = unit(1, "lines"),
    strip.text.x = element_text(
      size = 16,
      family = "Helvetica",
      face = "bold"
    ),
    axis.ticks.length = unit(0.125, "inch"),
    #ggh4x.axis.ticks.length.minor = rel(0.5),
    panel.border = element_blank(),
    panel.grid.major = element_blank(),
    axis.text = element_text(
      size = 20,
      colour = "black",
      family = "Helvetica"
    ),
    axis.title.y = element_text(
      size = 28,
      family = "Helvetica",
      margin = margin(
        t = 10,
        r = 5,
        b = 10,
        l = 10
      )
    ),
    axis.title.x = element_text(
      size = 28,
      family = "Helvetica",
      margin = margin(
        t = 5,
        r = 10,
        b = 10,
        l = 10
      )
    ),
    panel.grid.minor = element_blank(),
    axis.line = element_line(colour = "black"),
    plot.margin = margin(
      t = 5,
      r = 25,
      b = 5,
      l = 5
    )
  )

ggplot2::ggsave(
  filename = here::here("vignettes/figures/Figure_1.png"),
  plot = swus_date_distribution_stacked,
  width = 15.51,
  height = 10.32,
  dpi = 600
)

```

```{r Figure_2, fig.cap="Figure 2. maize_frontier", echo = FALSE, warning = FALSE, message = FALSE, error = FALSE, results = 'hide',fig.keep = 'all', fig.width = 15.51, fig.height = 10.32, fig.align = "left"}

nodes1 <-
  maize_frontier_mexico %>%
  dplyr::mutate(SiteName = ifelse(SiteName == "Elsinore Burial", SiteID, SiteName),
                SiteName = ifelse(SiteName == "Guila Naquitz", "GuilÃ¡ Naquitz", SiteName)) %>%
  dplyr::arrange(Date) %>%
  dplyr::mutate(id = dplyr::row_number()) %>%
  dplyr::select(id, Long, Lat, SiteName, Date) %>%
  sf::st_drop_geometry() %>%
  dplyr::mutate(delta = ((Lat - dplyr::lag(Lat))* 110.574) / (Date - dplyr::lag(Date)),
                delta = as.numeric(sprintf("%.2f", delta))) %>% 
  # dplyr::mutate(delta = (Lat - dplyr::lag(Lat)) / (Date - dplyr::lag(Date)),
  #               delta = as.numeric(sprintf("%.5f", delta))) %>%
  dplyr::mutate(normal = (delta - min(delta, na.rm = T)) / (max(delta, na.rm = T) -
                                                              min(delta, na.rm = T))) %>%
  dplyr::arrange(normal)

nodes1_rev <- nodes1 %>%
  dplyr::arrange(desc(normal))

nodes1$normal <- nodes1_rev$normal

names(nodes1) <-
  c("id", "lon", "lat", "name", "date", "delta", "normal")

nodes1 <- nodes1 %>%
  dplyr::arrange(id)

edges1 <- data.frame(
  from = 1:13,
  to = 2:14,
  weight = nodes1$normal[!is.na(nodes1$normal)],
  color = nodes1$delta[!is.na(nodes1$delta)]
)

g1 <-
  igraph::graph_from_data_frame(edges1, directed = FALSE, vertices = nodes1)

edges_for_plot1 <- edges1 %>%
  dplyr::inner_join(nodes1 %>% dplyr::select(id, lon, lat), by = c('from' = 'id')) %>%
  dplyr::rename(x = lon, y = lat) %>%
  dplyr::inner_join(nodes1 %>% dplyr::select(id, lon, lat), by = c('to' = 'id')) %>%
  dplyr::rename(xend = lon, yend = lat)
assertthat::assert_that(nrow(edges_for_plot1) == nrow(edges1))

country_shapes1 <-
  ggplot2::geom_polygon(
    aes(x = long, y = lat, group = group),
    data = map_data('world'),
    fill = "white",
    color = "black",
    size = 0.15
  )
country_shapes2 <- 
  ggplot2::geom_polygon(
    aes(x = long, y = lat, group = group),
    data = map_data('state'),
    fill = "white",
    color = "black",
    size = 0.15
  )
mapcoords1 <-
  ggplot2::coord_fixed(xlim = c(-114.814521,-92),
                       ylim = c(14.72716, 42.001167))

legend.breaks = 3

maize_frontier_mexico_delta_Lat <- ggplot(nodes1) +
  country_shapes1 +
  country_shapes2 +
  geom_curve(
    aes(
      x = x,
      y = y,
      xend = xend,
      yend = yend,
      #size = color,
      color = color
    ),
    arrow = arrow(length = unit(0.02, "npc"), type = "closed"),
    data = edges_for_plot1,
    curvature = 0.3,
    alpha = 1.0,
    size = 1.0
  ) +
  scale_color_distiller(palette = "RdYlGn", direction = 1, name = "\u0394 km N/year") +
  # scale_color_distiller(
  #   name = "\u0394 km N/year",
  #   breaks = seq(
  #     min(edges_for_plot1$color),
  #     max(edges_for_plot1$color),
  #     length.out = legend.breaks
  #   ),
  #   labels = sprintf("%.2f", seq(
  #     min(edges_for_plot1$color),
  #     max(edges_for_plot1$color),
  #     length.out = legend.breaks
  #   )),
  #      palette = "RdYlGn",
  #   direction="horizontal"
  # ) +
  # scale_size_continuous(
  #   name = "\u0394 km N/year",
  #   breaks = seq(
  #     min(edges_for_plot1$color),
  #     max(edges_for_plot1$color),
  #     length.out = legend.breaks
  #   ),
  #   labels = sprintf("%.2f", seq(
  #     min(edges_for_plot1$color),
  #     max(edges_for_plot1$color),
  #     length.out = legend.breaks
  #   ))
  # ) +    # scale for node size
  geom_point(
    aes(x = lon, y = lat),
    # draw nodes
    shape = 21,
    fill = 'white',
    color = 'black',
    stroke = 0.5,
    size = 3.5
  ) +
  ggrepel::geom_label_repel(
    aes(x = lon, y = lat, label = name),
    # draw text labels
    size = 2.25,
    color = "black",
    min.segment.length = 0.15,
    fill = alpha(c("white"), 0.7),
    force = 34,
    # nudge_x = -0.51,
    # nudge_y = 0.15,
    family = "Helvetica",
    max.overlaps = 15
  ) +
  #guides(color = guide_legend(), size = guide_legend()) +
  mapcoords1 +
 theme_void() +
  theme(
    plot.title = element_text(size=19, face = "bold", family = "Helvetica"),
    plot.margin = grid::unit(c(2,2,2,2), "mm"),
    legend.box.spacing = unit(15.0, "pt"),
    #legend.position = c(0.787, 0.764),
    legend.key.size = unit(0.65, "cm"),
    legend.text = element_text(size = 16, family = "Helvetica"),
    legend.title = element_text(
      size = 21,
      face = "bold",
      family = "Helvetica"
    )
  )
  #labs(title = "Change in Latitude North per Year")

# ggplot2::ggsave(
#   filename = here::here("vignettes/figures/spread_rate_mexico.png"),
#   plot = maize_frontier_mexico_delta_Lat,
#   width = 15.51,
#   height = 10.32,
#   dpi = 600
# )


nodes <-
  maize_frontier_mexico %>%
  dplyr::mutate(
    SiteName = ifelse(SiteName == "Elsinore Burial", SiteID, SiteName),
    SiteName = ifelse(SiteName == "Guila Naquitz", "GuilÃ¡ Naquitz", SiteName)
  ) %>%
  dplyr::arrange(Date) %>%
  dplyr::mutate(id = dplyr::row_number()) %>%
  #dplyr::select(id, Long, Lat, SiteName, Date) %>%
  dplyr::mutate(
    lead_row = geometry[dplyr::row_number() + 1],
    dist_deg = as.numeric(dplyr::lag(
      sf::st_distance(geometry, lead_row, by_element = TRUE, which = "Euclidean")
    )),
    dist_km = dist_deg * 110.574,
    delta_deg = dist_deg / (Date - dplyr::lag(Date)),
    delta_km = dist_km / (Date - dplyr::lag(Date)),
    delta_lat_deg = ((Lat - dplyr::lag(Lat))) / (Date - dplyr::lag(Date)),
    delta_lat_deg = as.numeric(sprintf("%.4f", delta_lat_deg)),
    delta_lat_km = delta_lat_deg * 110.574
  ) %>%
  dplyr::select(-lead_row) %>%
  sf::st_drop_geometry() %>% 
    dplyr::mutate(normal = (delta_km - min(delta_km, na.rm = T)) / (max(delta_km, na.rm = T) -
                                                              min(delta_km, na.rm = T))) %>%
  dplyr::arrange(normal)

maize_spread_table <- nodes %>% 
  dplyr::arrange(Date) %>% 
  dplyr::select(LabID, SiteName, NAME, REGION, Country, Date, Age, Error, MedianBP, GDD, elevation, dist_deg:delta_lat_km) %>% 
  dplyr::mutate(across(c(NAME, REGION), tools::toTitleCase),
                REGION = ifelse(SiteName == "GuilÃ¡ Naquitz", "Oaxaca", REGION))

names(maize_spread_table) <- c("Lab ID", "Site Name", "County", "State", "Country", "Date", 
"Age", "Error", "Median BP", "GDD", "Elevation", "Euclidean Distance (Degrees)", "Euclidean Distance (km)", 
"\u0394 Degrees Euclidean Distance/Year", "\u0394 km Euclidean Distance/Year", "\u0394 Degrees North/Year", "\u0394 km North/Year")
  
readr::write_excel_csv(maize_spread_table, here::here("vignettes/tables/Table_1.csv"))


nodes1 <- nodes %>% 
  dplyr::select(c("id", "Long", "Lat", "SiteName", "Date", "dist_deg", "dist_km", 
"delta_deg", "delta_km", "delta_lat_deg", "delta_lat_km", "normal"))

nodes1_rev <- nodes1 %>%
  dplyr::arrange(desc(normal))

nodes1$normal <- nodes1_rev$normal

names(nodes1) <-
  c("id", "lon", "lat", "name", "date", "dist_deg", "dist_km", "delta_deg", "delta_km", "delta_lat_deg", "delta_lat_km", "normal")

nodes1 <- nodes1 %>%
  dplyr::arrange(id)

edges1 <- data.frame(
  from = 1:13,
  to = 2:14,
  weight = nodes1$normal[!is.na(nodes1$normal)],
  color = nodes1$delta_km[!is.na(nodes1$delta_km)]
)

g1 <-
  igraph::graph_from_data_frame(edges1, directed = FALSE, vertices = nodes1)

edges_for_plot1 <- edges1 %>%
  dplyr::inner_join(nodes1 %>% dplyr::select(id, lon, lat), by = c('from' = 'id')) %>%
  dplyr::rename(x = lon, y = lat) %>%
  dplyr::inner_join(nodes1 %>% dplyr::select(id, lon, lat), by = c('to' = 'id')) %>%
  dplyr::rename(xend = lon, yend = lat)
assertthat::assert_that(nrow(edges_for_plot1) == nrow(edges1))

country_shapes1 <-
  ggplot2::geom_polygon(
    aes(x = long, y = lat, group = group),
    data = map_data('world'),
    fill = "white",
    color = "black",
    size = 0.15
  )
country_shapes2 <- 
  ggplot2::geom_polygon(
    aes(x = long, y = lat, group = group),
    data = map_data('state'),
    fill = "white",
    color = "black",
    size = 0.15
  )
mapcoords1 <-
  ggplot2::coord_fixed(xlim = c(-114.814521,-92),
                       ylim = c(14.72716, 42.001167))

legend.breaks = 3

maize_frontier_mexico_euclidean_dist <- ggplot(nodes1) +
  country_shapes1 +
  country_shapes2 +
  geom_curve(
    aes(
      x = x,
      y = y,
      xend = xend,
      yend = yend,
      #size = color,
      color = color
    ),
    arrow = arrow(length = unit(0.02, "npc"), type = "closed"),
    data = edges_for_plot1,
    curvature = 0.3,
    alpha = 1.0,
    size = 1.0
  ) +
  scale_color_distiller(palette = "RdYlGn", direction = 1, name = "\u0394 km ED/year") +
  # scale_color_distiller(
  #   name = "\u0394 km ED/year",
  #   breaks = seq(
  #     min(edges_for_plot1$color),
  #     max(edges_for_plot1$color),
  #     length.out = legend.breaks
  #   ),
  #   labels = sprintf("%.2f", seq(
  #     min(edges_for_plot1$color),
  #     max(edges_for_plot1$color),
  #     length.out = legend.breaks
  #   )),
  #  palette = "RdYlGn",
  #  direction="horizontal"
  #   
  # ) +
  # scale_size_continuous(
  #   name = "\u0394 km ED/year",
  #   breaks = seq(
  #     min(edges_for_plot1$color),
  #     max(edges_for_plot1$color),
  #     length.out = legend.breaks
  #   ),
  #   labels = sprintf("%.2f", seq(
  #     min(edges_for_plot1$color),
  #     max(edges_for_plot1$color),
  #     length.out = legend.breaks
  #   ))
  # ) +    # scale for node size
  geom_point(
    aes(x = lon, y = lat),
    # draw nodes
    shape = 21,
    fill = 'white',
    color = 'black',
    stroke = 0.5,
    size = 3.5
  ) +
  ggrepel::geom_label_repel(
    aes(x = lon, y = lat, label = name),
    # draw text labels
    size = 2.25,
    color = "black",
    min.segment.length = 0.15,
    fill = alpha(c("white"), 0.7),
    force = 34,
    # nudge_x = -0.51,
    # nudge_y = 0.15,
    family = "Helvetica",
    max.overlaps = 15
  ) +
  #guides(color = guide_legend(), size = guide_legend()) +
  mapcoords1 +
  theme_void() +
  theme(
    plot.title = element_text(size=19, face = "bold", family = "Helvetica"),
    plot.margin = grid::unit(c(2,2,2,2), "mm"),
    legend.box.spacing = unit(15.0, "pt"),
    #legend.position = c(0.787, 0.764),
    legend.key.size = unit(0.65, "cm"),
    legend.text = element_text(size = 16, family = "Helvetica"),
    legend.title = element_text(
      size = 21,
      face = "bold",
      family = "Helvetica"
    )
  )
  #labs(title = "Change in Euclidean Distance (km) per Year")
# 
# ggplot2::ggsave(
#   filename = here::here("vignettes/figures/spread_rate_mexico_euclidean.png"),
#   plot = maize_frontier_mexico_euclidean_dist,
#   # width = 15.51,
#   # height = 10.32,
#   dpi = 600
# )

Figure_2 <- cowplot::plot_grid(maize_frontier_mexico_delta_Lat, maize_frontier_mexico_euclidean_dist, labels = "AUTO", label_x = 0.275, label_y = 0.99, align = "v", nrow = 2, ncol = 1)
ggplot2::ggsave(
  Figure_2,
  filename = here::here("vignettes/figures/Figure_2.png"),
  # width = 32,
  # height = 24.75,
  dpi = 900
)


# Make a gridded plot.
# maize_frontier_SW_delta_euclidean
# maize_frontier_mexico_euclidean_dist
# maize_frontier_SW_delta_Lat
# maize_frontier_mexico_delta_Lat

# ggpubr::ggexport(
#   ggpubr::ggarrange(
#     maize_frontier_SW_delta_Lat,
#     maize_frontier_mexico_delta_Lat,
#     maize_frontier_SW_delta_euclidean,
#     maize_frontier_mexico_euclidean_dist,
#     labels = c("A", "B", "C", "D"),
#     ncol = 2,
#     nrow = 2,
#     align = "v"
#   ),
#   filename = here::here("vignettes/figures/spread_rate_ALL.png"),
#   width = 18.51,
#   height = 20.32
# )

```

```{r Figure_3, fig.cap="Figure 3. maize_frontier", echo = FALSE, warning = FALSE, message = FALSE, error = FALSE, results = 'hide',fig.keep = 'all', fig.width = 15.51, fig.height = 10.32, fig.align = "left"}

nodes1 <-
  maize_frontier_swus %>%
  dplyr::mutate(SiteName = ifelse(SiteName == "Elsinore Burial", SiteID, SiteName)) %>%
  dplyr::arrange(Date) %>%
  dplyr::mutate(id = dplyr::row_number()) %>%
  dplyr::select(id, Long, Lat, SiteName, Date) %>%
  sf::st_drop_geometry() %>%
  dplyr::mutate(delta = ((Lat - dplyr::lag(Lat))* 110.574) / (Date - dplyr::lag(Date)),
                delta = as.numeric(sprintf("%.2f", delta))) %>% 
  # dplyr::mutate(delta = (Lat - dplyr::lag(Lat)) / (Date - dplyr::lag(Date)),
  #               delta = as.numeric(sprintf("%.5f", delta))) %>%
  dplyr::mutate(normal = (delta - min(delta, na.rm = T)) / (max(delta, na.rm = T) -
                                                              min(delta, na.rm = T))) %>%
  dplyr::arrange(normal)

nodes1_rev <- nodes1 %>%
  dplyr::arrange(desc(normal))

nodes1$normal <- nodes1_rev$normal

names(nodes1) <-
  c("id", "lon", "lat", "name", "date", "delta", "normal")

nodes1 <- nodes1 %>%
  dplyr::arrange(id)

edges1 <- data.frame(
  from = 1:12,
  to = 2:13,
  weight = nodes1$normal[!is.na(nodes1$normal)],
  color = nodes1$delta[!is.na(nodes1$delta)]
)

g1 <-
  igraph::graph_from_data_frame(edges1, directed = FALSE, vertices = nodes1)

edges_for_plot1 <- edges1 %>%
  dplyr::inner_join(nodes1 %>% dplyr::select(id, lon, lat), by = c('from' = 'id')) %>%
  dplyr::rename(x = lon, y = lat) %>%
  dplyr::inner_join(nodes1 %>% dplyr::select(id, lon, lat), by = c('to' = 'id')) %>%
  dplyr::rename(xend = lon, yend = lat)
assertthat::assert_that(nrow(edges_for_plot1) == nrow(edges1))

country_shapes1 <-
  ggplot2::geom_polygon(
    aes(x = long, y = lat, group = group),
    data = map_data('state'),
    fill = "white",
    color = "black",
    size = 0.15
  )
mapcoords1 <-
  ggplot2::coord_fixed(xlim = c(-114.814521,-105),
                       ylim = c(31.333254, 42))

legend.breaks = 3

maize_frontier_SW_delta_Lat <- ggplot(nodes1) +
  country_shapes1 +
  geom_curve(
    aes(
      x = x,
      y = y,
      xend = xend,
      yend = yend,
      #size = color,
      color = color
    ),
    arrow = arrow(length = unit(0.02, "npc"), type = "closed"),
    data = edges_for_plot1,
    curvature = 0.3,
    alpha = 1.0,
    size = 1.0
  ) +
  scale_color_distiller(palette = "RdYlGn", direction = 1, name = "\u0394 km N/year") +
  # scale_color_distiller(
  #   name = "\u0394 km N/year",
  #   breaks = seq(
  #     min(edges_for_plot1$color),
  #     max(edges_for_plot1$color),
  #     length.out = legend.breaks
  #   ),
  #   labels = sprintf("%.2f", seq(
  #     min(edges_for_plot1$color),
  #     max(edges_for_plot1$color),
  #     length.out = legend.breaks
  #   )),
  #      palette = "RdYlGn",
  #  direction = "horizontal"
  # ) +
  # scale_size_continuous(
  #   name = "\u0394 km N/year",
  #   breaks = seq(
  #     min(edges_for_plot1$color),
  #     max(edges_for_plot1$color),
  #     length.out = legend.breaks
  #   ),
  #   labels = sprintf("%.2f", seq(
  #     min(edges_for_plot1$color),
  #     max(edges_for_plot1$color),
  #     length.out = legend.breaks
  #   ))
  # ) +    # scale for node size
  geom_point(
    aes(x = lon, y = lat),
    # draw nodes
    shape = 21,
    fill = 'white',
    color = 'black',
    stroke = 0.5,
    size = 3.5
  ) +
  ggrepel::geom_label_repel(
    aes(x = lon, y = lat, label = name),
    # draw text labels
    size = 2.75,
    color = "black",
    min.segment.length = 0.15,
    fill = alpha(c("white"), 0.7),
    force = 34,
    # nudge_x = -0.51,
    # nudge_y = 0.15,
    family = "Helvetica"
  ) +
  #guides(color = guide_legend(), size = guide_legend()) +
  mapcoords1 +
  # ggsn::north(x.min = -114, x.max = -114.08, 
  #             y.min = 31, y.max = 31.3, scale = 1.5) +
  theme_void() +
  theme(
    plot.margin = grid::unit(c(2,2,2,2), "mm"),
    plot.title = element_text(size=19, face = "bold", family = "Helvetica"),
    #legend.position = c(0.787, 0.764),
    legend.box.spacing = unit(15.0, "pt"),
    legend.key.size = unit(0.7, "cm"),
    legend.text = element_text(size = 16, family = "Helvetica"),
    legend.title = element_text(
      size = 21,
      face = "bold",
      family = "Helvetica"
    )
  )
#maize_frontier_SW_delta_Lat
  #ggtitle("Change in Latitude North per Year")

# ggplot2::ggsave(
#   filename = here::here("vignettes/figures/spread_rate.png"),
#   plot = maize_frontier_SW_delta_Lat,
#   width = 15.51,
#   height = 10.32,
#   dpi = 600
# )

nodes1 <-
  maize_frontier_swus %>%
  dplyr::mutate(
    SiteName = ifelse(SiteName == "Elsinore Burial", SiteID, SiteName),
    SiteName = ifelse(SiteName == "Guila Naquitz", "GuilÃ¡ Naquitz", SiteName)
  ) %>%
  dplyr::arrange(Date) %>%
  dplyr::mutate(id = dplyr::row_number()) %>%
  dplyr::select(id, Long, Lat, SiteName, Date) %>%
  dplyr::mutate(
    lead_row = geometry[dplyr::row_number() + 1],
    dist_deg = as.numeric(dplyr::lag(
      sf::st_distance(geometry, lead_row, by_element = TRUE, which = "Euclidean")
    )),
    dist_km = dist_deg * 110.574,
    delta_deg = dist_deg / (Date - dplyr::lag(Date)),
    delta_km = dist_km / (Date - dplyr::lag(Date)),
    delta_lat_deg = ((Lat - dplyr::lag(Lat))) / (Date - dplyr::lag(Date)),
    delta_lat_deg = as.numeric(sprintf("%.4f", delta_lat_deg)),
    delta_lat_km = delta_lat_deg * 110.574
  ) %>%
  dplyr::select(-lead_row) %>%
  sf::st_drop_geometry() %>% 
    dplyr::mutate(normal = (delta_km - min(delta_km, na.rm = T)) / (max(delta_km, na.rm = T) -
                                                              min(delta_km, na.rm = T))) %>%
  dplyr::arrange(normal)

nodes1_rev <- nodes1 %>%
  dplyr::arrange(desc(normal))

nodes1$normal <- nodes1_rev$normal

names(nodes1) <-
  c("id", "lon", "lat", "name", "date", "dist_deg", "dist_km", "delta_deg", "delta_km", "delta_lat_deg", "delta_lat_km", "normal")

nodes1 <- nodes1 %>%
  dplyr::arrange(id)

edges1 <- data.frame(
  from = 1:12,
  to = 2:13,
  weight = nodes1$normal[!is.na(nodes1$normal)],
  color = nodes1$delta_km[!is.na(nodes1$delta_km)]
)

g1 <-
  igraph::graph_from_data_frame(edges1, directed = FALSE, vertices = nodes1)

edges_for_plot1 <- edges1 %>%
  dplyr::inner_join(nodes1 %>% dplyr::select(id, lon, lat), by = c('from' = 'id')) %>%
  dplyr::rename(x = lon, y = lat) %>%
  dplyr::inner_join(nodes1 %>% dplyr::select(id, lon, lat), by = c('to' = 'id')) %>%
  dplyr::rename(xend = lon, yend = lat)
assertthat::assert_that(nrow(edges_for_plot1) == nrow(edges1))

country_shapes1 <-
  ggplot2::geom_polygon(
    aes(x = long, y = lat, group = group),
    data = map_data('state'),
    fill = "white",
    color = "black",
    size = 0.15
  )
mapcoords1 <-
  ggplot2::coord_fixed(xlim = c(-114.814521,-105),
                       ylim = c(31.333254, 42))

legend.breaks = 3

maize_frontier_SW_delta_euclidean <- ggplot(nodes1) +
  country_shapes1 +
  geom_curve(
    aes(
      x = x,
      y = y,
      xend = xend,
      yend = yend,
      #size = color,
      color = color
    ),
    arrow = arrow(length = unit(0.02, "npc"), type = "closed"),
    data = edges_for_plot1,
    curvature = 0.3,
    alpha = 1.0,
    size = 1.0
  ) +
  scale_color_distiller(palette = "RdYlGn", direction=1, name = "\u0394 km ED/year") +
  # scale_color_distiller(
  #   name = "\u0394 km ED/year",
  #   breaks = seq(
  #     min(edges_for_plot1$color),
  #     max(edges_for_plot1$color),
  #     length.out = legend.breaks
  #   ),
  #   labels = sprintf("%.2f", seq(
  #     min(edges_for_plot1$color),
  #     max(edges_for_plot1$color),
  #     length.out = legend.breaks
  #   )),
  #      palette = "RdYlGn",
  #  direction="horizontal"
  # ) +
  # scale_size_continuous(
  #   name = "\u0394 km ED/year",
  #   breaks = seq(
  #     min(edges_for_plot1$color),
  #     max(edges_for_plot1$color),
  #     length.out = legend.breaks
  #   ),
  #   labels = sprintf("%.2f", seq(
  #     min(edges_for_plot1$color),
  #     max(edges_for_plot1$color),
  #     length.out = legend.breaks
  #   ))
  # ) +    # scale for node size
  geom_point(
    aes(x = lon, y = lat),
    # draw nodes
    shape = 21,
    fill = 'white',
    color = 'black',
    stroke = 0.5,
    size = 3.5
  ) +
  ggrepel::geom_label_repel(
    aes(x = lon, y = lat, label = name),
    # draw text labels
    size = 2.75,
    color = "black",
    min.segment.length = 0.15,
    fill = alpha(c("white"), 0.7),
    force = 34,
    nudge_x = -0.51,
    nudge_y = 0.15,
    family = "Helvetica"
  ) +
  #guides(color = guide_legend(), size = guide_legend()) +
  mapcoords1 +
  theme_void() +
  theme(
    plot.title = element_text(size=19, face = "bold", family = "Helvetica"),
    plot.margin = grid::unit(c(2,2,2,2), "mm"),
    #legend.position = c(0.787, 0.764),
    legend.box.spacing = unit(15.0, "pt"),
    legend.key.size = unit(0.7, "cm"),
    legend.text = element_text(size = 16, family = "Helvetica"),
    legend.title = element_text(
      size = 21,
      face = "bold",
      family = "Helvetica"
    )
  )
  #labs(title = "Change in Euclidean Distance (km) per Year")

# ggplot2::ggsave( 
#   filename = here::here("vignettes/figures/spread_rate_euclidean.png"),
#   plot = maize_frontier_SW_delta_euclidean,
#   width = 15.51,
#   height = 10.32,
#   dpi = 600
# )

Figure_3 <- cowplot::plot_grid(maize_frontier_SW_delta_Lat, maize_frontier_SW_delta_euclidean, labels = "AUTO", label_x = 0.253, label_y = 0.99, align = "v", nrow = 2, ncol = 1)
ggplot2::ggsave(
  Figure_3,
  filename = here::here("vignettes/figures/Figure_3.png"),
  # width = 30.24,
  # height = 18.26,
  dpi = 900
)

```

```{r Figure_4, fig.cap="Figure 4. Box plots showing elevation, GDD, and latitude for each sample in our maize database, which includes 1,043 samples) through time (Gillreath-Brown and Kohler n.d. 2022). The samples have been binned into 500 year time slices and plotted on the midpoint of the 500 year time bin.", echo = FALSE, warning = FALSE, message = FALSE, error = FALSE, results = 'hide',fig.keep = 'all', fig.width = 15.51, fig.height = 10.32, fig.align = "left"}

MDB_env2 <- MDB_env %>%
  dplyr::filter(Lat >= 30 & Date < 1500) %>%
  dplyr::group_by(SiteIDName) %>%
  dplyr::slice_min(Date, with_ties = FALSE) %>% 
  dplyr::group_by(gr = cut(Date,
                           breaks = seq(-4000, 1500, 500),
                           labels = seq(-3750, 1250, 500))) %>% 
  dplyr::mutate(date2 = as.numeric(as.character(gr))) %>% 
  dplyr::ungroup() %>% 
  dplyr::select(-gr) %>% 
  dplyr::arrange(date2) %>% 
  dplyr::rename(Latitude = Lat, Elevation = elevation)

env_summaries <- MDB_env2 %>% 
  dplyr::summarise(dplyr::across(c(Latitude, GDD, Elevation), ~ mean(.x, na.rm = TRUE)))

env_summaries_bp <-
  MDB_env2 %>%
  dplyr::select(date2, Latitude, GDD, Elevation) %>%
  dplyr::rename(`Latitude (Â°)` = Latitude, `Annual GDD (Â°C)` = GDD, `Elevation (m)` = Elevation) %>% 
  tidyr::pivot_longer(-date2) %>%
  ggplot(aes(
    x = factor(date2),
    y = value,
    fill = factor(name)
  )) +
  geom_boxplot() +
  facet_grid(vars(name), scales = "free") +
  labs(fill = "") +
  xlab("Years BC/AD") +
  ylab("Value") +
  theme_bw() +
  theme(
    strip.text.y = element_text(size = 12),
    legend.key.size = unit(1.5, "cm"),
    legend.text = element_text(size = 12),
    axis.ticks.length = unit(0.125, "inch"),
    #ggh4x.axis.ticks.length.minor = rel(0.5),
    axis.text = element_text(
      size = 26,
      colour = "black",
      family = "Helvetica"
    ),
    axis.title.y = element_blank(),
    axis.title.x = element_text(
      size = 28,
      family = "Helvetica",
      margin = margin(
        t = 5,
        r = 10,
        b = 10,
        l = 10
      )
    ),
    axis.line = element_line(colour = "black"),
    plot.margin = margin(
      t = 5,
      r = 25,
      b = 5,
      l = 5
    )
  )

ggplot2::ggsave(
  filename = here::here("vignettes/figures/Figure_4.png"),
  plot = env_summaries_bp,
  width = 15.51,
  height = 10.32,
  dpi = 600
)

```

```{r Figure_5, fig.cap="Figure 5. SPDs by county with the earliest maize plotted for each county.", echo = FALSE, warning = FALSE, message = FALSE, error = FALSE, results = 'hide',fig.keep = 'all', fig.width = 15.51, fig.height = 10.32, fig.align = "left"}

MDB3A <- MDB %>%
  dplyr::filter(Country == "USA") %>%
  dplyr::select(LabID, Long, Lat, SiteIDName, MedianBP) %>%
  dplyr::mutate(SiteIDName = ifelse(SiteIDName == "Willard Mounds", "42BO3", SiteIDName))

maize_oldest <- cropSpreadR::sw_rc %>%
  dplyr::filter(stringr::str_detect(Taxa, "zea|Zea")) %>%
  dplyr::filter(LabID != "Beta-122953") %>%
  dplyr::filter(county_st %in% maize_frontier_swus$county_st)

maize_oldest2 <-
  rcarbon::calibrate(
    x = maize_oldest$Age,
    errors = maize_oldest$Error,
    calCurves = maize_oldest$calib,
    verbose = FALSE
  ) %>%
  summary() %>%
  dplyr::bind_cols(maize_oldest, .) %>%
  dplyr::select(county_st, MedianBP, LabID, SiteID, SiteName) %>%
  dplyr::group_by(county_st) %>%
  dplyr::slice_max(MedianBP, with_ties = FALSE) %>%
  dplyr::mutate(county_st = tools::toTitleCase(county_st)) %>%
  dplyr::left_join(.,
                   MDB %>% dplyr::select(LabID, SiteID, SiteName, SiteIDName),
                   by = "LabID") %>%
  dplyr::mutate(
    SiteID = dplyr::coalesce(SiteID.y, SiteID.x),
    SiteName = dplyr::coalesce(SiteName.y, SiteName.x),
    .keep = "unused"
  ) %>%
  dplyr::mutate(SiteNameID = dplyr::coalesce(SiteName, SiteID))

county_centroid <- cropSpreadR::SWUS_counties %>%
  sf::st_drop_geometry() %>%
  dplyr::select(county_st, centroid_lat) %>%
  dplyr::mutate(county_st = tools::toTitleCase(county_st))

by_county_changes <- cropSpreadR::SPD_county %>%
  dplyr::filter(county_st %in% maize_frontier_swus$county_st) %>%
  dplyr::mutate(county_st = tools::toTitleCase(county_st)) %>%
  dplyr::left_join(maize_oldest2, ., by = "county_st") %>%
  dplyr::left_join(
    .,
    cropSpreadR::SWUS_counties %>%
      sf::st_drop_geometry() %>%
      dplyr::select(county_st, centroid_lat) %>%
      dplyr::mutate(county_st = tools::toTitleCase(county_st)),
    by = "county_st"
  ) %>%
  dplyr::arrange(desc(centroid_lat)) %>%
  # Remove all columns with word site, except for SiteNameID, and remove name and region columns.
  dplyr::select(-c(starts_with("Site", vars = names(.)[stringr::str_detect(names(.), "SiteNameID", negate = TRUE)]), NAME, REGION, LabID)) %>%
  tidyr::unnest(cols = c(spds)) %>%
  dplyr::mutate(
    MedianBP = ifelse(MedianBP == calBP, MedianBP, NA),
    SiteNameID = ifelse(!is.na(MedianBP), SiteNameID, NA)
  ) %>%
  dplyr::mutate(county_st = paste0(county_st, " (n = ", n, ")")) %>% 
  dplyr::mutate(date_maize = rcarbon::BPtoBCAD(MedianBP),
                date_spd = rcarbon::BPtoBCAD(calBP)) %>% 
  dplyr::mutate(SiteNameID = ifelse(SiteNameID == "Elsinore Burial", "42SV2111", SiteNameID))


spd_plot <-
  ggplot(data = by_county_changes, aes(y = PrDens, x = date_spd)) +
  geom_line() +
  geom_point(
    aes(y = PrDens, x = date_maize),
    size = 2.75,
    color = "red",
    inherit.aes = FALSE
  ) +
  ggrepel::geom_label_repel(
    aes(y = PrDens, x = date_maize, label = SiteNameID),
    color = "red",
    cex = 5,
    show.legend  = F,
    min.segment.length = unit(0.1, 'lines'),
    box.padding = 1,
    nudge_x = -550,
    nudge_y = 0.35,
    fill = alpha(c("white"), 0.6),
    label.size = NA
  ) +
  theme_bw() +
  #scale_x_reverse(breaks = seq(0, 6000, 1000), limits = c(6000, 0)) +
  scale_x_continuous(breaks = seq(-4000, 2000, 1000), limits = c(-4100, 2000)) +
  scale_y_continuous(
    breaks = function(x)
      seq(0, max(x), length.out = 3),
    labels = function(y)
      sprintf("%.2f", y)
  ) +
  facet_wrap( ~ factor(county_st, levels = unique(by_county_changes$county_st)),
              scales = "free_y",
              ncol = 1) +
  xlab("Years BC/AD") +
  ylab("Summed Probability") +
  theme(
    legend.position = "none",
    panel.spacing = unit(1, "lines"),
    strip.text.x = element_text(
      size = 16,
      family = "Helvetica",
      face = "bold"
    ),
    axis.ticks.length = unit(0.125, "inch"),
    #ggh4x.axis.ticks.length.minor = rel(0.5),
    panel.border = element_blank(),
    panel.grid.major = element_blank(),
    axis.text = element_text(
      size = 20,
      colour = "black",
      family = "Helvetica"
    ),
    axis.title.y = element_text(
      size = 28,
      family = "Helvetica",
      margin = margin(
        t = 10,
        r = 5,
        b = 10,
        l = 10
      )
    ),
    axis.title.x = element_text(
      size = 28,
      family = "Helvetica",
      margin = margin(
        t = 5,
        r = 10,
        b = 10,
        l = 10
      )
    ),
    panel.grid.minor = element_blank(),
    axis.line = element_line(colour = "black"),
    plot.margin = margin(
      t = 5,
      r = 25,
      b = 5,
      l = 5
    )
  )

spd_plot

ggplot2::ggsave(
  filename = here::here("vignettes/figures/Figure_5.png"),
  plot = spd_plot,
  width = 16,
  height = 18,
  dpi = 600
)

```

```{r Figure_6, fig.cap="Figure 6. SPDs by county with the earliest maize plotted for each county.", echo = FALSE, warning = FALSE, message = FALSE, error = FALSE, results = 'hide',fig.keep = 'all', fig.width = 15.51, fig.height = 10.32, fig.align = "left"}

# Get sites that are on the northern maize frontier through time from cropDiffusionR package.
temp <- tempfile()
download.file(
  "https://raw.githubusercontent.com/Archaeo-Programmer/cropDiffusionR/master/vignettes/output/maize_frontier_swus.rds",
  temp
)
maize_frontier_swus <-
  readr::read_rds(temp, "maize_frontier_swus.rds") %>% 
  dplyr::left_join(., MDB %>% dplyr::select(LabID, Long, Lat), by = "LabID")
unlink(temp)

# Create new column for fill, which will be used for plotting. Grey if the county occurs on the maize northern frontier, and blank if it does not.
SWUS_counties_fill <- cropSpreadR::SWUS_counties %>% 
  dplyr::mutate(fill = ifelse(county_st %in% maize_frontier_swus$county_st, "grey", NA),
                label = ifelse(county_st %in% maize_frontier_swus$county_st, tools::toTitleCase(NAME), NA))

# Plot.
spd_counties <- ggplot(data = SWUS_counties_fill) +
  geom_sf(
    color = "black",
    fill = SWUS_counties_fill$fill,
    size = 0.25
  ) +
    ggrepel::geom_label_repel(
    aes(label = label, geometry = geom),
    stat = "sf_coordinates",
    min.segment.length = 0.1,
    size = 7
  ) +
  #   geom_label_repel(
  #   aes(y = PrDens, x = MedianBP, label = SiteNameID),
  #   color = "red",
  #   cex = 5,
  #   show.legend  = F,
  #   min.segment.length = unit(0.1, 'lines'),
  #   box.padding = 1,
  #   nudge_x = -550,
  #   nudge_y = 0.35,
  #   fill = alpha(c("white"), 0.6),
  #   label.size = NA
  # ) +
  coord_sf() +
  theme_bw() +
  theme(
    legend.position = c(.15, .2),
    panel.border = element_blank(),
    panel.grid.major = element_blank(),
    axis.text = element_blank(),
    axis.text.x = element_blank(),
    axis.title = element_blank(),
    axis.line = element_blank(),
    axis.ticks = element_blank(),
    legend.text = element_text(size = 15, family = "Helvetica"),
    legend.title = element_text(
      size = 16,
      family = "Helvetica",
      face = "bold"
    )
  )
  
ggplot2::ggsave(
  filename = here::here("vignettes/figures/Figure_6.png"),
  plot = spd_counties,
  width = 15.51,
  height = 10.32,
  dpi = 600
)

```

```{r Figure_7, fig.cap="Figure 7. GDD and elevation for Four Corners", echo = FALSE, warning = FALSE, message = FALSE, error = FALSE, results = 'hide',fig.keep = 'all', fig.width = 15.51, fig.height = 10.32, fig.align = "left"}

# GDD Map
# Get raster for the North American Southwest and convert to a dataframe.
gdd_cropped <-
  raster::crop(cropSpreadR::PRISM_annual_gdd, cropDiffusionR::swus_states)
gdd_cropped <-
  raster::mask(gdd_cropped, cropDiffusionR::swus_states)

NASW_gdd_data <-
  raster::as.data.frame(gdd_cropped, xy = TRUE)
# Assign names to the columns.
names(NASW_gdd_data) <- c("long", "lat", "GDD")
#Transform the data for plotting in ggplot.
NASW_gdd_data_transformed <-
  usmap::usmap_transform(
    NASW_gdd_data,
    input_names = c("long", "lat"),
    output_names = c("x", "y")
  )

maize_frontier_swus_tp <- maize_frontier_swus %>%
  dplyr::mutate(`Site Type` = "Maize Frontier") %>% 
  dplyr::bind_rows(
    .,
    MDB %>%
      dplyr::filter(SiteName == "Turkey Pen Ruin") %>%
      dplyr::slice_min(Date) %>%
      dplyr::mutate(Long1 = Long, Lat1 = Lat) %>%
      # Convert to spatial object
      sf::st_as_sf(coords = c("Long1", "Lat1"),
                   crs = 4326) %>%
      sf::st_make_valid() %>% 
      dplyr::mutate(`Site Type` = "Other")
  ) %>% 
  dplyr::mutate(SiteName = ifelse(SiteName == "Elsinore Burial", SiteID, SiteName))

GDD_output <- ggplot2::ggplot(data = NASW_gdd_data_transformed) +
  geom_raster(aes(x = long, y = lat, fill = GDD),
              alpha = 0.8,
              na.rm = TRUE) +
  # For GDD raster in greyscale.
  # scale_fill_gradientn(
  #   colors = grey.colors(
  #     10,
  #     start = 0.15,
  #     end = 0.9,
  #     rev = TRUE
  #   ),
  #   na.value = "transparent",
  #   name = "Annual GDDs "
  # ) +
#For GDD raster in color.
scale_fill_gradientn(colors = colorRampPalette(rev(RColorBrewer::brewer.pal(11, "RdBu")))(255),
                     na.value = "transparent",
                     name = "Annual GDD (Â°C)") +
  coord_equal() +
  theme_bw() +
  geom_sf(
    data = cropDiffusionR::swus_states,
    color = "#2b2b2b",
    fill = "transparent",
    size = 0.4,
    inherit.aes = FALSE
  ) +
  geom_sf(
    data = maize_frontier_swus_tp,
    aes(geometry = geometry, 
        shape = `Site Type`),
    inherit.aes = FALSE,
    size = 4,
    show.legend = "point"
  ) +
  scale_shape_manual(values = c(16, 17)) +
  ggrepel::geom_label_repel(
    data = maize_frontier_swus_tp,
    aes(label = SiteName, geometry = geometry),
    stat = "sf_coordinates",
    min.segment.length = 0.4,
    force = 47,
    label.size = 0,
    size = 4.5,
    inherit.aes = FALSE,
    max.overlaps = 20,
    fill = alpha(c("white"),0.7)
  ) +
  theme(
    #legend.position = c(.15, .2),
    panel.border = element_blank(),
    panel.grid.major = element_blank(),
    axis.text = element_blank(),
    axis.text.x = element_blank(),
    axis.title = element_blank(),
    axis.line = element_blank(),
    axis.ticks = element_blank(),
    legend.text = element_text(size = 15, family = "Helvetica"),
    legend.title = element_text(
      size = 16,
      family = "Helvetica",
      face = "bold"
    )
  )


# Elevation Map

NASW_ned_data <-
  raster::as.data.frame(swus_NED, xy = TRUE)
# Assign names to the columns.
names(NASW_ned_data) <- c("long", "lat", "elev")
# Transform the data for plotting in ggplot.
swus_NED_transformed <-
  usmap::usmap_transform(
    NASW_ned_data,
    input_names = c("long", "lat"),
    output_names = c("x", "y")
  )

NED_output <- ggplot2::ggplot(data = swus_NED_transformed) +
  geom_raster(aes(x = long, y = lat, fill = elev),
              alpha = 0.8,
              na.rm = TRUE) +
  # For GDD raster in greyscale.
  # scale_fill_gradientn(
  #   colors = grey.colors(
  #     10,
  #     start = 0.15,
  #     end = 0.9,
  #     rev = TRUE
  #   ),
  #   na.value = "transparent",
  #   name = "Annual GDDs "
  # ) +
#For GDD raster in color.
scale_fill_gradientn(colors = grDevices::colorRampPalette(MetBrewer::met.brewer("VanGogh3"))(256),
                     na.value = "transparent",
                     name = "Elevation (m)") +
  coord_equal() +
  theme_bw() +
  geom_sf(
    data = cropDiffusionR::swus_states,
    color = "#2b2b2b",
    fill = "transparent",
    size = 0.4,
    inherit.aes = FALSE
  ) +
  geom_sf(
    data = maize_frontier_swus_tp,
    aes(geometry = geometry, 
        shape = `Site Type`),
    inherit.aes = FALSE,
    size = 4,
    show.legend = "point"
  ) +
  scale_shape_manual(values = c(16, 17)) +
  ggrepel::geom_label_repel(
    data = maize_frontier_swus_tp,
    aes(label = SiteName, geometry = geometry),
    stat = "sf_coordinates",
    min.segment.length = 0.4,
    force = 47,
    label.size = 0,
    size = 4.5,
    inherit.aes = FALSE,
    max.overlaps = 20,
    fill = alpha(c("white"),0.7)
  ) +
  theme(
    #legend.position = c(.15, .2),
    panel.border = element_blank(),
    panel.grid.major = element_blank(),
    axis.text = element_blank(),
    axis.text.x = element_blank(),
    axis.title = element_blank(),
    axis.line = element_blank(),
    axis.ticks = element_blank(),
    legend.text = element_text(size = 15, family = "Helvetica"),
    legend.title = element_text(
      size = 16,
      family = "Helvetica",
      face = "bold"
    )
  )


fig_envA <- cowplot::plot_grid(NED_output, GDD_output, labels = "AUTO", label_x = 0.26, align = "v", nrow = 2, ncol = 1)
ggplot2::ggsave(
  fig_envA,
  filename = here::here("vignettes/figures/Figure_7.png"),
  # width = 30.24,
  # height = 18.26,
  dpi = 600
)

# fig_envB <- cowplot::plot_grid(NED_output, GDD_output, labels = "AUTO", label_x = 0.21, align = "v", ncol = 1)
# ggplot2::ggsave(
#   fig_envB,
#   filename = here::here("vignettes/figures/fig_envb.png"),
#   width = 16.72,
#   height = 18.26,
#   dpi = 600
# )

```

```{r multi_regression}

mlr <- MDB_env %>%
  dplyr::group_by(SiteIDName) %>%
  dplyr::slice_min(Date) %>%
  dplyr::filter(Lat >= 30 & Date < 1500) %>%
  dplyr::mutate(bin = cut(Date,
                          breaks = seq(-3700, 1500, 100))) %>%
  dplyr::group_by(bin) %>%
  dplyr::mutate(group = dplyr::cur_group_id()) %>%
  dplyr::filter(LabID %in% maize_frontier_swus$LabID) %>%
  dplyr::ungroup()

mlr2 <- mlr %>%
  dplyr::select(Date, Lat, elevation, GDD) %>% 
  dplyr::mutate(dplyr::across(everything(), scales::rescale))

gdd_lat <- lm(GDD ~ Lat, data = mlr2)
gdd_elev <- lm(GDD ~ elevation, data = mlr2)
date_lat <- lm(Date ~ Lat, data = mlr2)
date_elev <- lm(Date ~ elevation, data = mlr2)
date_gdd <- lm(Date ~ GDD, data = mlr2)

stats_table <-
  purrr::map_dfr(list(gdd_lat, gdd_elev, date_lat, date_elev, date_gdd), function(x) {
    x %>%
      summary() %>%
      {
        data.frame(
          formula = as.character(.$call)[[2]],
          slope = formatC(.$coefficients[2, 1], digits = 3, format = "f"),
          r2 = formatC(.$r.squared, digits = 2, format = "f"),
          pvalue = formatC(.$coefficients[2, 4],
                           digits = 3,
                           format = "f"),
          Fstatistic = formatC(.$fstatistic[[1]],
                               digits = 2,
                               format = "f")
        )
      } })



fit <- lm(Date ~ Lat + GDD + elevation, data = mlr)
summary(fit)

fit <- lm(Date ~ GDD * Lat + elevation * GDD, data = mlr)
summary(fit)

summary(lm(Date ~ (Lat + GDD + elevation)^2, data = mlr))
summary(lm(Date ~ Lat * GDD + elevation * GDD, data = mlr))

anova_table <- anova(fit)
effectsize(anova_table)
effectsize(anova_table, type = "f2")

#produce added variable plots
car::avPlots(fit)

car::leveragePlots(fit)

mlr %>%
  dplyr::select(Date, Lat, GDD, elevation) %>%
  ggplot(aes(Date, GDD)) +
  geom_smooth(
    method = 'lm',
    formula = y ~ x,
    se = T,
    fullrange = TRUE
    #aes(color = name)
  ) +
  #scale_x_reverse() +
  geom_point()


mlr %>%
  dplyr::select(Date, Lat, GDD, elevation) %>%
  #dplyr::select(Date, Lat) %>%
  tidyr::pivot_longer(-Date) %>%
  ggplot(aes(Date, value)) +
  geom_smooth(
    method = 'lm',
    formula = y ~ x,
    se = T,
    fullrange = TRUE
    #aes(color = name)
  ) +
  #scale_x_reverse() +
  geom_point() +
  facet_wrap(vars(name), scales = "free")

added_variable_plots <- mlr

model_wt_and_disp <- lm(Date ~ Lat + GDD + elevation, data = mlr)

model_lat <- lm(Date ~ Lat, data = added_variable_plots)
added_variable_plots$lat_residuals <- residuals(model_lat) 

model_gdd <- lm(Date ~ GDD, data = added_variable_plots)
added_variable_plots$gdd_residuals <- residuals(model_gdd) 

model_elev <- lm(Date ~ elevation, data = added_variable_plots)
added_variable_plots$elev_residuals <- residuals(model_elev)

model_gdd_elev_against_Lat <- lm(GDD + elevation ~ Lat, data = added_variable_plots)
added_variable_plots$gdd_elev_against_Lat_residuals <- residuals(model_gdd_elev_against_Lat)

model_lat_elev_against_gdd <- lm(Lat + elevation ~ GDD, data = added_variable_plots)
added_variable_plots$lat_elev_against_gdd_residuals <- residuals(model_lat_elev_against_gdd)

model_lat_gdd_against_elev <- lm(Lat + GDD ~ elevation, data = added_variable_plots)
added_variable_plots$lat_gdd_against_elev_residuals <- residuals(model_lat_gdd_against_elev)

one <- ggplot(added_variable_plots, aes(x = gdd_elev_against_Lat_residuals, y = lat_residuals)) +
  geom_point() + geom_smooth(method = 'lm', color = '#e76254') +
    labs(title = "Mtcars", subtitle = "Parial Regression: mpg ~ wt + disp") +
  theme(plot.title = element_text(hjust = 0.5, face = "bold")) +
  theme(plot.subtitle = element_text(hjust = 0.5)) +
  labs(caption = "holding Lat constant") +
  xlab("GDD + Elevation \n (gdd_elev_against_Lat_residuals)") +
  ylab("Latitude \n (lat_residuals)")

two <- ggplot(added_variable_plots, aes(x = lat_elev_against_gdd_residuals, y = gdd_residuals)) +
  geom_point() + geom_smooth(method = 'lm', color = '#ef8a47') +
  labs(title = "Mtcars", subtitle = "Parial Regression: mpg ~ wt + disp") +
  theme(plot.title = element_text(hjust = 0.5, face = "bold")) +
  theme(plot.subtitle = element_text(hjust = 0.5)) +
  labs(caption = "holding GDD constant") +
  xlab("Latitude + Elevation \n (lat_elev_against_gdd_residuals)") +
  ylab("GDD \n (gdd_residuals)")


three <- ggplot(added_variable_plots, aes(x = lat_gdd_against_elev_residuals, y = elev_residuals)) +
  geom_point() + geom_smooth(method = 'lm', color = '#ef8a47') +
  labs(title = "Mtcars", subtitle = "Parial Regression: mpg ~ wt + disp") +
  theme(plot.title = element_text(hjust = 0.5, face = "bold")) +
  theme(plot.subtitle = element_text(hjust = 0.5)) +
  labs(caption = "holding elevation constant") +
  xlab("Latitude + GDD \n (lat_gdd_against_elev_residuals)") +
  ylab("Elevation \n (gdd_residuals)")

library(patchwork)
one + two + three

library(ggplot2)
library(gridExtra)

mod <- fit

p1 <- qplot(.fitted, .resid, data = mod) +
  geom_hline(yintercept = 0) +
  geom_smooth(se = FALSE)

p2 <- qplot(sample =.stdresid, data = mod, stat = "qq") + geom_abline()

p3 <- qplot(.fitted, sqrt(abs(.stdresid)), data = mod) + geom_smooth(se = FALSE)

p4 <- qplot(.hat, .stdresid, data = mod) + geom_smooth(se = FALSE)


grid.arrange(p1,p2,p3,p4)

```





# Exploration Code
```{r code_exploration}

# Getting spread rates between random sites.
tv_bc <- MDB %>%
  dplyr::filter(SiteName %in% c("Guila Naquitz", "Las Capas")) %>%
  dplyr::group_by(SiteName) %>%
  dplyr::slice_min(Date) %>%
  dplyr::select(Long, Lat, SiteName, Date) %>%
  dplyr::ungroup()

tv_bc_out <- tv_bc %>%
  dplyr::mutate(Long1 = Long, Lat1 = Lat) %>%
  sf::st_as_sf(coords = c("Long1", "Lat1")) %>%
  dplyr::arrange(Date) %>%
  # dplyr::mutate(delta_lat = ((Lat - dplyr::lag(Lat))* 110.574) / (Date - dplyr::lag(Date)),
  #               delta_lat = as.numeric(sprintf("%.2f", delta_lat))) %>%
  # dplyr::mutate(delta_deg = (Lat - dplyr::lag(Lat)) / (Date - dplyr::lag(Date)),
  #               delta_deg = as.numeric(sprintf("%.5f", delta_deg))) %>%
  dplyr::mutate(
    lead_row = geometry[dplyr::row_number() + 1],
    dist_deg = as.numeric(dplyr::lag(
      sf::st_distance(geometry, lead_row, by_element = TRUE, which = "Euclidean")
    )),
    dist_km = dist_deg * 110.574,
    delta_deg = dist_deg / (Date - dplyr::lag(Date)),
    delta_km = dist_km / (Date - dplyr::lag(Date)),
    delta_lat_deg = ((Lat - dplyr::lag(Lat))) / (Date - dplyr::lag(Date)),
    delta_lat_deg = as.numeric(sprintf("%.4f", delta_lat_deg)),
    delta_lat_km = delta_lat_deg * 110.574
  ) %>%
  dplyr::select(-lead_row) %>%
  sf::st_drop_geometry() %>%
  suppressWarnings()



library(tidyverse)

MDB2 <- MDB %>% 
  filter(Lat >= 30) %>% 
  arrange(Lat, Long)

interpolated <- interp(MDB2$Long, MDB2$Lat, MDB2$MedianBP, 
                       duplicate = "mean",    #you have duplicated values
                       output = "grid")

#convert this to a long form dataframe
interp_df <- expand_grid(i = seq_along(interpolated$x), 
                         j = seq_along(interpolated$y)) %>% 
  dplyr::mutate(lon = interpolated$x[i],
         lat = interpolated$y[j],
         emissions = map2_dbl(i, j, ~interpolated$z[.x,.y])) %>% 
  dplyr::select(-i, -j)

#then you can use this in your plot
ggplot()+
  geom_point(data = MDB2, aes(x = Long, y = Lat), col = "blue") +
  geom_contour(data = interp_df, aes(x = lon, y = lat, z = emissions), binwidth = 300) + 
  geom_text_contour(data = interp_df, aes(x = lon, y = lat, z = emissions), binwidth = 300) +
    geom_sf(
    data = cropDiffusionR::usa_mexico_states,
    color = "#2b2b2b",
    fill = "transparent",
    size = 0.4,
    inherit.aes = FALSE
  ) +
  scale_y_continuous(limits = c(30, 42)) +
  scale_x_continuous(limits = c(-115, -104))

library(akima)

fld <- with(MDB2, interp(x = Long, y = Lat, z = MedianBP, duplicate = "mean"))

ok <- filled.contour(x = fld$x,
               y = fld$y,
               z = fld$z,
               color.palette =
                 colorRampPalette(wes_palette("Zissou1", 21, type = "continuous")),
               xlab = "Longitude",
               ylab = "Latitude",
               main = "Years BP",
               #plot.axes=maps::map('state',add=T))
               plot.axes = { contour(fld$x,fld$y,fld$z,  
                                 drawlabels = TRUE, axes = FALSE, 
                                 frame.plot = FALSE, add = TRUE);
             axis(1); axis(2); maps::map('state',add=T); points(5, 5) })


library(raster)
library(fields)


xy <- data.frame(x = MDB2$Long, y = MDB2$Lat)
z = MDB2$MedianBP
rast <- raster(ext=extent(xy), crs=4326, resolution = 0.01)

m <- fields::Tps(xy, z)
surface <- raster::interpolate(rast, m)

plot(surface)
contour(surface, add = TRUE)


library(akima)
library(metR)
library("wesanderson")
library(scales)

MDB2 <- MDB %>% 
  dplyr::filter(Lat >= 30 & Date <= 1500) %>% 
  dplyr::arrange(desc(MedianBP)) %>% 
  dplyr::group_by(Long, Lat) %>% 
  dplyr::slice_max(MedianBP, with_ties = FALSE)

fld <- with(df_clus,
            interp(
              x = coords.x1,
              y = coords.x2,
              z = z,
              xo = seq(min(coords.x1), max(coords.x1), length = 800),
              yo = seq(min(coords.x2), max(coords.x2), length = 800)
              #duplicate = "mean"
            ))

gdat <- interp2xyz(fld, data.frame = TRUE)

ok <- ggplot(gdat) +
  aes(x = x,
      y = y,
      z = z,
      fill = z) +
  geom_tile() +
  coord_equal() +
  stat_contour(aes(fill= fit <<- ..level..), geom="polygon", binwidth=300) + 
  geom_contour(color = "white", alpha = 0.8) +
  geom_text_contour(binwidth = 300) +
  scale_fill_gradientn(colors = wes_palette("Zissou1", 21, type = "continuous"),
                       na.value = "transparent", name="Years BP") +
  theme_bw() +
  scale_y_continuous(limits = c(30, 42)) +
  scale_x_continuous(limits = c(-115, -104)) +
  geom_sf(
    data = cropDiffusionR::usa_mexico_states,
    color = "#2b2b2b",
    fill = "transparent",
    size = 0.4,
    inherit.aes = FALSE
  ) +
  #geom_point(data = MDB2, aes(x = Long, y = Lat), size = 3, inherit.aes = FALSE) +
  xlab("") +
  ylab("")


hello <- ggplot2::ggplot_build(ok)$data[[2]]

out <- hello %>% 
  dplyr::select(year = order, Long = x, Lat = y) %>% 
  sf::st_as_sf(coords = c("Long", "Lat"), crs = 4326, remove = FALSE) %>% 
  dplyr::bind_cols(., gdd = terra::extract(x = cropDiffusionR::NASW_gdd, y = .)) %>% 
  dplyr::filter(!is.na(gdd)) %>% 
  sf::st_drop_geometry() %>% 
  dplyr::group_by(year) %>% 
  summarise(Lat = mean(Lat), gdd = mean(gdd)) %>% 
  dplyr::arrange(desc(year)) %>% 
  dplyr::mutate(deltaLat = Lat - lag(Lat),
                deltaGDD = gdd - lag(gdd),
                date = rcarbon::BPtoBCAD(year))


# Change in latitude.
out %>%
  ggplot2::ggplot(aes(x = date, y = Lat)) +
  geom_line(size = 2, color = "#A60F2D") +
  xlab("Years BC/AD") +
  ylab("Latitude") +
  scale_x_continuous(breaks = seq(-2600, 1100, 300)) +
  # scale_y_continuous(
  #   breaks = seq(-0.7, 0, 0.1),
  #   limits = c(-0.7, 0),
  #   minor_breaks = seq(-0.65,-0.05, by = 0.05),
  #   guide = "axis_minor"
  # ) +
  theme_bw() +
  theme(
    axis.ticks.length = unit(0.125, "inch"),
    #ggh4x.axis.ticks.length.minor = rel(0.5),
    panel.border = element_blank(),
    panel.grid.major = element_blank(),
    axis.text = element_text(
      size = 26,
      colour = "black",
      family = "Helvetica"
    ),
    axis.title.y = element_text(
      size = 28,
      family = "Helvetica",
      margin = margin(
        t = 10,
        r = 5,
        b = 10,
        l = 10
      )
    ),
    axis.title.x = element_text(
      size = 28,
      family = "Helvetica",
      margin = margin(
        t = 5,
        r = 10,
        b = 10,
        l = 10
      )
    ),
    panel.grid.minor = element_blank(),
    axis.line = element_line(colour = "black"),
    plot.margin = margin(
      t = 5,
      r = 25,
      b = 5,
      l = 5
    )
  )

# Change in gdd (delta)
out %>%
  ggplot2::ggplot(aes(x = date, y = deltaGDD)) +
  geom_line(size = 2, color = "#A60F2D") +
  xlab("Years BC/AD") +
  ylab("Delta GDD") +
  scale_x_continuous(breaks = seq(-2600, 1100, 300)) +
  scale_y_reverse(
    breaks = seq(-4500, 500, 500)
  ) +
  theme_bw() +
  theme(
    axis.ticks.length = unit(0.125, "inch"),
    #ggh4x.axis.ticks.length.minor = rel(0.5),
    panel.border = element_blank(),
    panel.grid.major = element_blank(),
    axis.text = element_text(
      size = 26,
      colour = "black",
      family = "Helvetica"
    ),
    axis.title.y = element_text(
      size = 28,
      family = "Helvetica",
      margin = margin(
        t = 10,
        r = 5,
        b = 10,
        l = 10
      )
    ),
    axis.title.x = element_text(
      size = 28,
      family = "Helvetica",
      margin = margin(
        t = 5,
        r = 10,
        b = 10,
        l = 10
      )
    ),
    panel.grid.minor = element_blank(),
    axis.line = element_line(colour = "black"),
    plot.margin = margin(
      t = 5,
      r = 25,
      b = 5,
      l = 5
    )
  )


# GDD 
out %>%
  ggplot2::ggplot(aes(x = date, y = gdd)) +
  geom_line(size = 2, color = "#A60F2D") +
  xlab("Years BC/AD") +
  ylab("GDD") +
  scale_x_continuous(breaks = seq(-2600, 1100, 300)) +
  scale_y_reverse(
    breaks = seq(1000, 4000, 500)
  ) +
  theme_bw() +
  theme(
    axis.ticks.length = unit(0.125, "inch"),
    #ggh4x.axis.ticks.length.minor = rel(0.5),
    panel.border = element_blank(),
    panel.grid.major = element_blank(),
    axis.text = element_text(
      size = 26,
      colour = "black",
      family = "Helvetica"
    ),
    axis.title.y = element_text(
      size = 28,
      family = "Helvetica",
      margin = margin(
        t = 10,
        r = 5,
        b = 10,
        l = 10
      )
    ),
    axis.title.x = element_text(
      size = 28,
      family = "Helvetica",
      margin = margin(
        t = 5,
        r = 10,
        b = 10,
        l = 10
      )
    ),
    panel.grid.minor = element_blank(),
    axis.line = element_line(colour = "black"),
    plot.margin = margin(
      t = 5,
      r = 25,
      b = 5,
      l = 5
    )
  )

```

```{r Figure_1_old, fig.cap="Figure 1. TPS of earliest maize at each site.", echo = FALSE, warning = FALSE, message = FALSE, error = FALSE, results = 'hide',fig.keep = 'all', fig.width = 15.51, fig.height = 10.32, fig.align = "left"}

library(sp)
library(rgdal)
library(geosphere)
library(raster)
library(fields)

# TPS_inter <- MDB %>%
#   dplyr::group_by(SiteIDName) %>%
#   dplyr::slice_max(MedianBP) %>%
#   dplyr::filter(Lat >= 30 & Date < 1500)

TPS_inter <- maize_frontier_swus %>%
  dplyr::bind_rows(MDB %>% dplyr::filter(LabID == "NSRL-12484"))

x = TPS_inter$Long
y = TPS_inter$Lat
z = TPS_inter$Date

# convert data to a SpatialPointsDataFrame object
xysp <- SpatialPointsDataFrame(
  matrix(c(x, y), ncol = 2),
  data.frame(ID = seq(1:length(x))),
  proj4string = CRS("+proj=longlat +ellps=WGS84 +datum=WGS84")
)

# use the distm function to generate a geodesic distance matrix in meters
mdist <- distm(xysp)

# cluster all points using a hierarchical clustering approach
hc <- hclust(as.dist(mdist), method = "complete")

# define the distance threshold, in this case 40 m
d = 6437.38

# define clusters based on a tree "height" cutoff "d" and add them to the SpDataFrame
xyp2 <- xysp
xyp2$clust <- cutree(hc, h = d)

df_clus <- as.data.frame(xyp2, z, TPS_inter$SiteIDName) %>%
  dplyr::group_by(clust) %>%
  dplyr::slice_min(z, with_ties = FALSE) %>%
  dplyr::ungroup() %>%
  dplyr::select(-c(ID, clust)) %>%
  dplyr::filter(!TPS_inter.SiteIDName %in% c("AA:12:745", "AA:12:232"))

xy <- data.frame(x = df_clus$coords.x1, y = df_clus$coords.x2)
z2 = df_clus$z
rast <- raster::raster(ext = extent(xy),
                       crs = 4326,
                       resolution = 0.01)

m <- fields::Tps(xy, z2)
surface <- raster::interpolate(rast, m)

png(
  here::here("vignettes/figures/Figure_1_test.png"),
  units = "in",
  width = 15.43,
  height = 13.15,
  res = 600
)

plot(
  surface,
  xlim = c(-113.7015, -104.7915),
  ylim = c(30.30626, 41.47626),
  col = rev(wesanderson::wes_palette("Zissou1", 21, type = "continuous")),
  asp = NA,
  xaxt = 'n',
  yaxt = 'n',
  legend.args = list(
    text = "      Years \n       BC/AD \n",
    side = 3,
    font = 2,
    cex = 1.5
  ),
  legend.width = 1.25,
  legend.shrink = 0.75
)
# contour(
#   surface,
#   asp = NA,
#   add = TRUE,
#   labcex = 1.1,
#   xaxt = 'n',
#   yaxt = 'n',
#   vfont = c("sans serif", "bold")
# )
maps::map(
  'state',
  add = TRUE,
  lwd = 1.5,
  lty = 1,
  col = "grey28"
)

dev.off()


# Supplemental figure that just has the contour lines.
# Need to re-run code above so that it uses MedianBP instead of Date. 
# Also, for df_clus, you will need to use slice_max for MedianBP instead of slice_min (which is used for Date).
png(
  here::here("vignettes/figures/supplemental/Supp_Figure_contour.png"),
  units = "in",
  width = 15.43,
  height = 13.15,
  res = 600
)

contour(
  surface,
  asp = NA,
  add = FALSE,
  labcex = 1.1,
  xaxt = 'n',
  yaxt = 'n',
  vfont = c("sans serif", "bold")
)
maps::map(
  'state',
  add = TRUE,
  lwd = 1.5,
  lty = 1,
  col = "grey28"
)

dev.off()

```
